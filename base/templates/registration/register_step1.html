{% extends "registration/layout.html" %} 
{% load static %}
{% block title %} Fruit Cast | Register {% endblock title %} 

{%block content %}
<div class="container-fluid auth-container d-flex justify-content-center align-items-center min-vh-100 py-4">
  <div class="row w-100 justify-content-center">
    <div class="col-12 col-sm-10 col-md-8 col-lg-7 col-xl-6 col-xxl-5">
      <div class="card shadow-lg border-0 rounded-4 auth-card">
        <div class="card-body p-4 p-md-5">
          <!-- Logo/Brand -->
          <div class="text-center mb-4">
            <div class="text-success mb-2">
                <img src="{% static 'images/logo/3.png' %}" alt="Fruit Cast Logo" style="max-height: 10rem;" class="me-2">

            </div>
            <h1 class="h2 text-success fw-bold mb-0">Fruit Cast</h1>
            <p class="text-muted small">Complete your registration</p>
            
            <!-- Show the email being used for registration -->
            {% if reg_email %}
            <div class="alert alert-info border-0 bg-light-info mb-4">
              <div class="d-flex align-items-center">
                <i class="bi bi-info-circle text-primary me-2"></i>
                <small class="text-muted">
                  Registering with: <strong>{{ reg_email }}</strong>
                </small>
              </div>
            </div>
            {% endif %}
          </div>

          <form method="POST" id="register-form" novalidate>
            {% csrf_token %}
            
            <!-- Personal Information Section -->
            <div class="mb-4 registration-section">
              <h5 class="text-success mb-3">
                <i class="bi bi-person me-2"></i>Personal Information
              </h5>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label" for="id_firstname">
                    <i class="bi bi-person-badge me-1"></i>First Name *
                  </label>
                  {{ form.firstname }}
                  {% if form.firstname.errors %}
                    <div class="text-danger small mt-1">{{ form.firstname.errors }}</div>
                  {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label" for="id_lastname">
                    <i class="bi bi-person-badge me-1"></i>Last Name *
                  </label>
                  {{ form.lastname }}
                  {% if form.lastname.errors %}
                    <div class="text-danger small mt-1">{{ form.lastname.errors }}</div>
                  {% endif %}
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label" for="id_middlename">
                    <i class="bi bi-person-badge me-1"></i>Middle Name
                  </label>
                  {{ form.middlename }}
                  {% if form.middlename.errors %}
                    <div class="text-danger small mt-1">{{ form.middlename.errors }}</div>
                  {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label" for="id_nameextension">
                    <i class="bi bi-person-badge me-1"></i>Name Extension
                  </label>
                  {{ form.nameextension }}
                  {% if form.nameextension.errors %}
                    <div class="text-danger small mt-1">{{ form.nameextension.errors }}</div>
                  {% endif %}
                </div>
              </div>
               
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label" for="id_sex">
                    <i class="bi bi-gender-ambiguous me-1"></i>Sex *
                  </label>
                  {{ form.sex }}
                  {% if form.sex.errors %}
                    <div class="text-danger small mt-1">{{ form.sex.errors }}</div>
                  {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label" for="id_birthdate">
                    <i class="bi bi-calendar me-1"></i>Date of Birth *
                  </label>
                  {{ form.birthdate }}
                  {% if form.birthdate.errors %}
                    <div class="text-danger small mt-1">{{ form.birthdate.errors }}</div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Contact Information Section -->
            <div class="mb-4 registration-section">
              <h5 class="text-success mb-3">
                <i class="bi bi-telephone me-2"></i>Contact Information
              </h5>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label" for="id_contact_number">
                    <i class="bi bi-phone me-1"></i>Contact Number *
                  </label>
                  {{ form.contact_number }}
                  {% if form.contact_number.errors %}
                    <div class="text-danger small mt-1">{{ form.contact_number.errors }}</div>
                  {% endif %}
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label" for="id_emergency_contact_person">
                    <i class="bi bi-person-check me-1"></i>Emergency Contact Person *
                  </label>
                  {{ form.emergency_contact_person }}
                  {% if form.emergency_contact_person.errors %}
                    <div class="text-danger small mt-1">{{ form.emergency_contact_person.errors }}</div>
                  {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label" for="id_emergency_contact_number">
                    <i class="bi bi-person-check me-1"></i>Emergency Contact Number *
                  </label>
                  {{ form.emergency_contact_number }}
                  {% if form.emergency_contact_number.errors %}
                    <div class="text-danger small mt-1">{{ form.emergency_contact_number.errors }}</div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Address Information Section -->
            <div class="mb-4 registration-section">
              <h5 class="text-success mb-3">
                <i class="bi bi-geo-alt me-2"></i>Address Information
              </h5>
              
              <div class="mb-3">
                <label class="form-label" for="id_address_details">
                  <i class="bi bi-house me-1"></i>Address Details *
                </label>
                {{ form.address_details }}
                {% if form.address_details.errors %}
                  <div class="text-danger small mt-1">{{ form.address_details.errors }}</div>
                {% endif %}
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label" for="id_municipality_id">
                    <i class="bi bi-building me-1"></i>Municipality *
                  </label>
                  {{ form.municipality_id }}
                  {% if form.municipality_id.errors %}
                    <div class="text-danger small mt-1">{{ form.municipality_id.errors }}</div>
                  {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label" for="id_barangay_id">
                    <i class="bi bi-signpost me-1"></i>Barangay *
                  </label>
                  {{ form.barangay_id }}
                  {% if form.barangay_id.errors %}
                    <div class="text-danger small mt-1">{{ form.barangay_id.errors }}</div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Additional Information Section -->
            <div class="mb-4 registration-section">
              <h5 class="text-success mb-3">
                <i class="bi bi-info-circle me-2"></i>Additional Information
              </h5>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label" for="id_religion">
                    <i class="bi bi-heart me-1"></i>Religion *
                  </label>
                  {{ form.religion }}
                  {% if form.religion.errors %}
                    <div class="text-danger small mt-1">{{ form.religion.errors }}</div>
                  {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label" for="id_civil_status">
                    <i class="bi bi-people me-1"></i>Civil Status *
                  </label>
                  {{ form.civil_status }}
                  {% if form.civil_status.errors %}
                    <div class="text-danger small mt-1">{{ form.civil_status.errors }}</div>
                  {% endif %}
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label" for="id_rsbsa_ref_number">
                    <i class="bi bi-file-text me-1"></i>RSBSA Reference Number
                  </label>
                  {{ form.rsbsa_ref_number }}
                  <small class="form-text text-muted">Optional - for registered farmers</small>
                </div>
              </div>
            </div>

            <div class="d-grid gap-2 mt-4">
              <button type="submit" class="btn btn-success btn-md">
                <i class="bi bi-check-circle me-2"></i>Complete Registration
              </button>
            </div>

            <!-- Cancel Registration Section -->
            <div class="text-center mt-4">
              <div class="border-top pt-3">
                {% comment %} <p class="text-muted mb-3">Want to use a different email?</p> {% endcomment %}
                <a href="{% url 'base:cancel_registration' %}" class="btn btn-outline-danger" 
                   onclick="return confirm('Are you sure? This will cancel your current registration and you will need to start over.')">
                  <i class="bi bi-x-circle me-2"></i>Cancel Registration
                </a>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // Enhanced Phone Number Formatting
  function formatPhoneNumber(input) {
    let value = input.value.replace(/\D/g, ''); // Remove all non-digits
    
    // Ensure it starts with +63
    if (!input.value.startsWith('+63')) {
      input.value = '+63';
      value = '';
    }
    
    // Remove the country code from value for formatting
    if (value.startsWith('63')) {
      value = value.substring(2);
    }
    
    // Format as +639XX XXX XXXX
    if (value.length >= 1 && value.charAt(0) === '9') {
      if (value.length <= 3) {
        input.value = '+63 9' + value.substring(1);
      } else if (value.length <= 6) {
        input.value = '+63 9' + value.substring(1, 3) + ' ' + value.substring(3);
      } else if (value.length <= 10) {
        input.value = '+63 9' + value.substring(1, 3) + ' ' + value.substring(3, 6) + ' ' + value.substring(6, 10);
      } else {
        // Limit to 10 digits after +63
        value = value.substring(0, 10);
        input.value = '+63 9' + value.substring(1, 3) + ' ' + value.substring(3, 6) + ' ' + value.substring(6, 10);
      }
    } else {
      // If doesn't start with 9, reset to +639
      input.value = '+63 9';
    }
  }

  function validatePhoneNumber(input) {
    const phoneRegex = /^\+63 9\d{2} \d{3} \d{4}$/;
    const isValid = phoneRegex.test(input.value);
    
    if (input.value.length > 4 && !isValid) {
      input.setCustomValidity('Phone number must be in the format: +63 9XX XXX XXXX');
    } else {
      input.setCustomValidity('');
    }
    
    return isValid;
  }

  // Apply phone formatting to all phone inputs
  const phoneInputs = document.querySelectorAll('.phone-input');
  phoneInputs.forEach(function(input) {
    // Set initial value
    if (!input.value || input.value === '') {
      input.value = '+63';
    }
    
    input.addEventListener('input', function(e) {
      const cursorPosition = e.target.selectionStart;
      formatPhoneNumber(e.target);
      
      // Prevent cursor from moving when typing
      if (cursorPosition <= 3) {
        e.target.setSelectionRange(4, 4); // Position after +63
      }
    });
    
    input.addEventListener('keydown', function(e) {
      // Prevent deletion of +63
      if (e.target.selectionStart < 4 && (e.key === 'Backspace' || e.key === 'Delete')) {
        e.preventDefault();
        e.target.setSelectionRange(4, 4);
      }
    });
    
    input.addEventListener('blur', function(e) {
      validatePhoneNumber(e.target);
    });
    
    input.addEventListener('focus', function(e) {
      if (e.target.value === '+63') {
        e.target.setSelectionRange(4, 4);
      }
    });
  });

  // Name validation for character restrictions
  function validateNameInput(input) {
    const nameRegex = /^[a-zA-Z√Ä-√ø\u0100-\u017F\u1E00-\u1EFF'\-\s\.]*$/;
    const value = input.value;
    
    if (!nameRegex.test(value)) {
      // Remove invalid characters
      input.value = value.replace(/[^a-zA-Z√Ä-√ø\u0100-\u017F\u1E00-\u1EFF'\-\s\.]/g, '');
    }
  }

  // Religion field validation (character restrictions + 50 character limit)
  function validateReligionInput(input) {
    const religionRegex = /^[a-zA-Z√Ä-√ø\u0100-\u017F\u1E00-\u1EFF'\-\s\.]*$/;
    let value = input.value;
    
    // Remove invalid characters
    if (!religionRegex.test(value)) {
      value = value.replace(/[^a-zA-Z√Ä-√ø\u0100-\u017F\u1E00-\u1EFF'\-\s\.]/g, '');
    }
    
    // Limit to 50 characters
    if (value.length > 50) {
      value = value.substring(0, 50);
    }
    
    input.value = value;
  }

  // Address details validation (150 character limit)
  function validateAddressInput(input) {
    const maxLength = 150;
    if (input.value.length > maxLength) {
      input.value = input.value.substring(0, maxLength);
    }
  }

  // Apply name validation to name fields
  const nameFields = ['id_firstname', 'id_lastname', 'id_middlename', 'id_nameextension', 'id_emergency_contact_person'];
  nameFields.forEach(function(fieldId) {
    const field = document.getElementById(fieldId);
    if (field) {
      field.addEventListener('input', function(e) {
        validateNameInput(e.target);
      });
    }
  });

  // Apply religion validation
  const religionField = document.getElementById('id_religion');
  if (religionField) {
    religionField.addEventListener('input', function(e) {
      validateReligionInput(e.target);
    });
  }

  // Apply address validation
  const addressField = document.getElementById('id_address_details');
  if (addressField) {
    addressField.addEventListener('input', function(e) {
      validateAddressInput(e.target);
    });
  }

  // Municipality and Barangay handling
  const municipalitySelect = document.getElementById('id_municipality_id');
  const barangaySelect = document.getElementById('id_barangay_id');

  // Initialize barangay dropdown
  if (barangaySelect) {
    barangaySelect.innerHTML = '<option value="">Select a municipality first</option>';
    barangaySelect.disabled = true;
  }

  if (municipalitySelect && barangaySelect) {

  municipalitySelect.addEventListener('change', function () {
    const municipalityId = this.value;
    barangaySelect.innerHTML = '';
    barangaySelect.disabled = true;

    if (municipalityId) {
      console.log('üîç Fetching barangays for municipality ID:', municipalityId);
      barangaySelect.innerHTML = '<option value="">Loading barangays...</option>';
      
      fetch(`/get-barangays/${municipalityId}/`)
        .then(response => {
          console.log('üì° Response status:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('üìã Received barangay data:', data);
          
          if (data && data.length > 0) {
            barangaySelect.disabled = false;
            barangaySelect.innerHTML = '<option value="">Select a barangay</option>';
            
            data.forEach(barangay => {
              const option = document.createElement('option');
              option.value = barangay.id;
              option.textContent = barangay.barangay;
              barangaySelect.appendChild(option);
            });
            
            console.log('‚úÖ Successfully populated barangay dropdown with', data.length, 'options');
          } else {
            barangaySelect.innerHTML = '<option value="">No barangays available</option>';
            console.log('‚ö†Ô∏è No barangays found for municipality ID:', municipalityId);
          }
        })
        .catch(error => {
          console.error('‚ùå Error fetching barangays:', error);
          barangaySelect.innerHTML = '<option value="">Error loading barangays</option>';
        });
    } else {
      barangaySelect.innerHTML = '<option value="">Select a municipality first</option>';
      console.log('üîÑ Municipality cleared, reset barangay dropdown');
    }
  });
  } // Close municipalitySelect && barangaySelect check

  // Simple year validation for birthdate
  const birthdateInput = document.getElementById('id_birthdate');
  if (birthdateInput) {
    birthdateInput.addEventListener('input', function() {
      const value = this.value;
      if (value) {
        const dateParts = value.split('-');
        // Limit year to 4 digits
        if (dateParts[0] && dateParts[0].length > 4) {
          dateParts[0] = dateParts[0].substring(0, 4);
          this.value = dateParts.join('-');
        }
      }
    });
  }

  // Add form submission debugging
  const registerForm = document.getElementById('register-form');
  if (registerForm) {
    registerForm.addEventListener('submit', function(e) {
      console.log('\n' + '='.repeat(50));
      console.log('üîç FRONTEND REGISTRATION DEBUG - FORM SUBMISSION');
      console.log('='.repeat(50));
      
      const formData = new FormData(this);
      const formObj = {};
      for (let [key, value] of formData.entries()) {
        formObj[key] = value;
      }
      
      console.log('üìù Form Data:', formObj);
      console.log('üèòÔ∏è Municipality Selected:', formObj.municipality_id);
      console.log('üè† Barangay Selected:', formObj.barangay_id);
      
      // Check if municipality is Orani (pk=9)
      if (formObj.municipality_id === '9') {
        console.log('üéØ DETECTED ORANI SELECTION (pk=9)!');
        console.log('üèòÔ∏è Municipality Name: Orani');
        
        // Get the selected barangay name
        const barangaySelect = document.getElementById('id_barangay_id');
        if (barangaySelect && barangaySelect.selectedOptions.length > 0) {
          console.log('üè† Barangay Name:', barangaySelect.selectedOptions[0].textContent);
        }
      }
      
      // Validate required fields
      const requiredFields = ['firstname', 'lastname', 'sex', 'birthdate', 'contact_number', 'emergency_contact_person', 'emergency_contact_number', 'address_details', 'municipality_id', 'barangay_id', 'religion', 'civil_status'];
      const missingFields = [];
      
      requiredFields.forEach(field => {
        if (!formObj[field] || formObj[field].trim() === '') {
          missingFields.push(field);
        }
      });
      
      // Validate phone numbers
      const phoneFields = ['contact_number', 'emergency_contact_number'];
      phoneFields.forEach(field => {
        const phoneInput = document.getElementById('id_' + field);
        if (phoneInput && !validatePhoneNumber(phoneInput)) {
          e.preventDefault();
          phoneInput.focus();
          alert('Please enter a valid phone number in the format: +63 9XX XXX XXXX');
          return false;
        }
      });
      
      if (missingFields.length > 0) {
        console.log('‚ùå Missing required fields:', missingFields);
      } else {
        console.log('‚úÖ All required fields filled');
      }
      
      console.log('üì§ Form submission proceeding...');
      console.log('='.repeat(50));
      
      // Let the form submit normally
    });
  }
});
</script>

<style>
.phone-input:focus {
    border-color: #198754;
    box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
}

.phone-input:invalid {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

/* Character limit indicators */
.form-control[maxlength] {
    position: relative;
}

.char-limit-info {
    font-size: 0.75rem;
    color: #6c757d;
    text-align: right;
    margin-top: 0.25rem;
}

.char-limit-warning {
    color: #ffc107;
}

.char-limit-danger {
    color: #dc3545;
}
</style>

{% endblock content %}