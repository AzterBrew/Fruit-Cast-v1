{% extends "registration/layout.html" %}
{% load static %}

{% block title %}Fruit Cast | Verify Code{% endblock title %}

{% block content %}
<div class="container-fluid auth-container d-flex justify-content-center align-items-center min-vh-100 py-4">
  <div class="row w-100 justify-content-center">
    <div class="col-12 col-sm-8 col-md-6 col-lg-5 col-xl-4 col-xxl-3">
      <div class="card shadow-lg border-0 rounded-4 auth-card">
        <div class="card-body p-4 p-md-5">
          <!-- Logo/Brand -->
          <div class="text-center mb-4">
            <div class="text-info mb-2">
              <img src="{% static 'images/logo/3.png' %}" alt="Fruit Cast Logo" style="max-height: 10rem;" class="me-2">
            </div>
            <h1 class="h2 text-success fw-bold mb-0">Verify Code</h1>
            <p class="text-muted small">Enter the verification code sent to</p>
            <p class="text-success fw-bold small">{{ email }}</p>
          </div>

          <form method="POST">
            {% csrf_token %}
            
            <div class="mb-4">
              <label class="form-label" for="otp_code">
                <i class="bi bi-shield-lock me-2"></i>Verification Code
              </label>
              <input 
                class="form-control form-control-lg text-center" 
                type="text" 
                name="otp_code" 
                id="otp_code"
                placeholder="Enter 6-digit code" 
                maxlength="6"
                required
                autocomplete="one-time-code"
                pattern="[0-9]{6}"
                style="letter-spacing: 4px; font-size: 1.5rem; font-weight: bold;"
              >
              <div class="form-text text-center">
                <i class="bi bi-clock me-1"></i>
                Code expires in: <span id="countdown" class="fw-bold text-warning">10:00</span>
              </div>
            </div>

            {% if messages %}
              {% for message in messages %}
                <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
                  <i class="bi bi-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-triangle{% elif message.tags == 'warning' %}exclamation-triangle-fill{% elif message.tags == 'info' %}info-circle{% else %}info-circle{% endif %} me-2"></i>
                  {{ message }}
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
              {% endfor %}
            {% endif %}

            <div class="d-grid gap-2 mt-4">
              <button type="submit" class="btn btn-info btn-md" id="verifyBtn">
                <i class="bi bi-check-circle me-2"></i>Verify & Continue
              </button>
            </div>

            <div class="text-center mt-4">
              <div class="border-top pt-3">
                <p class="text-muted mb-3">Need a new code?</p>
                <a href="{% url 'base:change_password' %}" class="btn btn-outline-warning">
                  <i class="bi bi-arrow-clockwise me-2"></i>Start Over
                </a>
              </div>
              <div class="mt-3">
                <a href="{% url 'base:account_info_panel' %}" class="link-secondary text-decoration-none small">
                  <i class="bi bi-arrow-left me-1"></i>Cancel & Return to Account
                </a>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const otpInput = document.getElementById('otp_code');
    const verifyBtn = document.getElementById('verifyBtn');
    const countdownElement = document.getElementById('countdown');
    
    // Auto-focus OTP input
    if (otpInput) {
        otpInput.focus();
    }
    
    // Countdown timer (10 minutes)
    let timeLeft = 10 * 60; 
    
    function updateCountdown() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        countdownElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (timeLeft <= 0) {
            countdownElement.textContent = 'Expired';
            countdownElement.parentElement.innerHTML = '<i class="bi bi-exclamation-triangle text-danger me-1"></i>Code has expired. Please request a new one.';
            otpInput.disabled = true;
            verifyBtn.disabled = true;
            verifyBtn.textContent = 'Code Expired';
        } else {
            timeLeft--;
        }
    }
    
    // Update countdown every second
    updateCountdown();
    const countdownInterval = setInterval(updateCountdown, 1000);
    
    // Format OTP input - only allow numbers
    otpInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/[^0-9]/g, '');
        if (value.length > 6) {
            value = value.slice(0, 6);
        }
        e.target.value = value;
        
        // Auto-submit when 6 digits are entered
        if (value.length === 6) {
            // Small delay to show the complete input
            setTimeout(() => {
                if (timeLeft > 0) {
                    e.target.form.submit();
                }
            }, 500);
        }
    });
    
    // Prevent paste of non-numeric content
    otpInput.addEventListener('paste', function(e) {
        e.preventDefault();
        const paste = (e.clipboardData || window.clipboardData).getData('text');
        const numericPaste = paste.replace(/[^0-9]/g, '').slice(0, 6);
        e.target.value = numericPaste;
        
        if (numericPaste.length === 6 && timeLeft > 0) {
            setTimeout(() => {
                e.target.form.submit();
            }, 500);
        }
    });
    
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const code = otpInput.value.trim();
        
        if (timeLeft <= 0) {
            e.preventDefault();
            alert('Verification code has expired. Please request a new one.');
            return false;
        }
        
        if (!code || code.length !== 6) {
            e.preventDefault();
            alert('Please enter the complete 6-digit verification code.');
            otpInput.focus();
            return false;
        }
        
        // Disable button to prevent double submission
        verifyBtn.disabled = true;
        verifyBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Verifying...';
    });
    
    window.addEventListener('beforeunload', function() {
        clearInterval(countdownInterval);
    });
});
</script>
{% endblock content %}