{% load static %}

{% block content %}
<div class="container p-4">
    
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-success fw-bold mb-1">
                <i class="bi bi-scissors me-2"></i>Create New Harvest Record
            </h2>
            <p class="text-muted mb-0">Record your harvest information and yield data</p>
        </div>
    </div>

    <!-- Plant Information Card (if from transaction) -->
    {% if transaction %}
    <div class="card bg-light border-0 mb-4">
        <div class="card-body">
            <h6 class="text-success fw-semibold mb-3">
                <i class="bi bi-info-circle me-2"></i>Related Plant Record Information
            </h6>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-2">
                        <strong>Planted Commodity:</strong>
                        <span class="badge bg-success ms-2">
                            {% if transaction.initplantrecord.commodity_id.pk == 1 %}
                                {{ transaction.initplantrecord.commodity_custom }}
                            {% else %}
                                {{ transaction.initplantrecord.commodity_id.name }}
                            {% endif %}
                        </span>
                    </div>
                    <div class="text-muted small">
                        <i class="bi bi-calendar3 me-1"></i>
                        Date of Planting: <strong>{{ transaction.initplantrecord.plant_date|date:"M d, Y" }}</strong>
                    </div>
                </div>
                <div class="col-md-6">
                    {% if transaction.location_type == 'farm_land' %}
                        <div class="mb-1">
                            <i class="bi bi-geo-alt me-1"></i>
                            <strong>Farm:</strong> {{ transaction.farm_land.farmland_name }}
                        </div>
                        <div class="text-muted small">
                            <i class="bi bi-map me-1"></i>
                            {{ transaction.farm_land.municipality.municipality }}, {{ transaction.farm_land.barangay.barangay }}
                        </div>
                    {% elif transaction.location_type == 'manual' %}
                        <div class="mb-1">
                            <i class="bi bi-geo-alt me-1"></i>
                            <strong>Location:</strong> {{ transaction.manual_municipality.municipality }}, {{ transaction.manual_barangay.barangay }}
                        </div>
                    {% endif %}
                    {% if transaction.initplantrecord.remarks %}
                        <div class="text-muted small mt-2">
                            <i class="bi bi-chat-left-text me-1"></i>
                            <strong>Plant Remarks:</strong> {{ transaction.initplantrecord.remarks }}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Information Alert -->
    <div class="alert alert-warning border-0 mb-4">
        <div class="d-flex align-items-center">
            <i class="bi bi-info-circle text-warning me-3 fs-5"></i>
            <p class="mb-0 small">
                <strong>Note:</strong> Proceeding with Record does not mean the record has been saved in the database. 
                Proceed with Record and Complete the Transaction to successfully submit the record.
            </p>
        </div>
    </div>

    <form method="POST" novalidate id="harvest-record-form">
        {% csrf_token %}

        <!-- Harvest Details Section -->
        <div class="mb-4">
            <h5 class="text-success mb-3">
                <i class="bi bi-clipboard-data me-2"></i>Harvest Details
            </h5>
            <div class="row g-3">
                {% if transaction %}
                    <div class="col-md-6">
                        <label class="form-label" for="{{ form.harvest_date.id_for_label }}">{{ form.harvest_date.label }}</label>
                        {{ form.harvest_date }}
                        {% if form.harvest_date.errors %}
                            <div class="text-danger small mt-1">{{ form.harvest_date.errors }}</div>
                        {% endif %}
                    </div>
                    <input type="hidden" name="commodity_id" value="{{ transaction.initplantrecord.commodity_id.pk }}">
                    <input type="hidden" name="commodity_custom" value="{{ transaction.initplantrecord.commodity_custom }}">
                    <div class="col-md-6">
                        <label class="form-label" for="{{ form.total_weight.id_for_label }}">{{ form.total_weight.label }}</label>
                        {{ form.total_weight }}
                        {% if form.total_weight.errors %}
                            <div class="text-danger small mt-1">{{ form.total_weight.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="{{ form.unit.id_for_label }}">{{ form.unit.label }}</label>
                        {{ form.unit }}
                        {% if form.unit.errors %}
                            <div class="text-danger small mt-1">{{ form.unit.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="{{ form.weight_per_unit.id_for_label }}">{{ form.weight_per_unit.label }}</label>
                        {{ form.weight_per_unit }}
                        {% if form.weight_per_unit.errors %}
                            <div class="text-danger small mt-1">{{ form.weight_per_unit.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-12">
                        <label class="form-label" for="{{ form.remarks.id_for_label }}">{{ form.remarks.label }}</label>
                        {{ form.remarks }}
                        {% if form.remarks.errors %}
                            <div class="text-danger small mt-1">{{ form.remarks.errors }}</div>
                        {% endif %}
                    </div>
                {% else %}
                    {% for field in form %}
                        <div class="col-md-6">
                            <label class="form-label">{{ field.label_tag }}</label>
                            {{ field }}
                            {% if field.errors %}
                                <div class="text-danger small mt-1">{{ field.errors }}</div>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>

        <!-- Location Section (for standalone harvest records) -->
        {% if not transaction %}
        <div class="mt-4 pt-3 border-top">
            <h5 class="text-success mb-3">
                <i class="bi bi-geo-alt me-2"></i>Location Information
            </h5>
            <div class="alert alert-warning border-0 mb-3">
                <p class="mb-0 small">
                    <i class="bi bi-lightbulb me-1"></i>
                    If you own a farm land that you would like to use for your records, you should first 
                    <a href="{% url 'base:farmland_record' %}" class="alert-link" style="text-decoration: underline;">set up your farm land information here</a> 
                    before creating a harvest record.
                </p>
            </div>
            
            <div class="row g-3">
                {% for field in transaction_form %}
                {% if field.name != "manual_barangay" and field.name != "manual_municipality" %}
                    <div class="col-md-6">
                        <label class="form-label">{{ field.label_tag }}</label>
                        {{ field }}
                        {% if field.errors %}
                            <div class="text-danger small mt-1">{{ field.errors }}</div>
                        {% endif %}
                    </div>
                {% endif %}
                {% endfor %}
                <div class="col-md-6">
                    <label class="form-label" for="id_manual_municipality">Municipality</label>
                    {{ transaction_form.manual_municipality }}
                </div>
                <div class="col-md-6">
                    <label class="form-label" for="id_manual_barangay">Barangay</label>
                    <select name="manual_barangay" id="id_manual_barangay" class="form-select" disabled>
                        <option value="">Select a municipality first</option>
                    </select>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Action Buttons -->
        <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mt-4 pt-3 border-top">
            <button type="submit" class="btn btn-success">
                <i class="bi bi-check-circle me-2"></i>Proceed with Record
            </button>
            
            <div class="d-flex flex-wrap gap-2">
                {% if transaction %}
                    <a href="{% url 'base:transaction_recordlist' transaction.transaction_id%}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>Back to Transaction Record
                    </a>
                {% else %}
                    <a href="{% url 'base:newrecord' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle me-2"></i>Cancel
                    </a>
                {% endif %}
            </div>
        </div> 
    </form>
</div>

<script>

document.addEventListener('DOMContentLoaded', function() {
    
    // Simple validation to prevent negative values and restrict input
    function preventNegativeInput(input) {
        let value = input.value;
        
        // Remove any non-numeric characters except decimal point
        value = value.replace(/[^0-9.]/g, '');
        
        // Limit to 13 characters total
        if (value.length > 13) {
            value = value.substring(0, 13);
        }
        
        // Ensure only one decimal point
        const parts = value.split('.');
        if (parts.length > 2) {
            value = parts[0] + '.' + parts.slice(1).join('');
        }
        
        input.value = value;
        
        // Validate minimum value (greater than zero)
        if (parseFloat(value) <= 0 && value !== '') {
            input.setCustomValidity('Value must be greater than 0');
        } else {
            input.setCustomValidity('');
        }
    }

    // Apply validation to weight fields
    const numericFields = ['id_total_weight', 'id_weight_per_unit'];
    numericFields.forEach(function(fieldId) {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', function(e) {
                preventNegativeInput(e.target);
            });
            
            field.addEventListener('blur', function(e) {
                // Ensure minimum value on blur if field has value
                if (e.target.value && parseFloat(e.target.value) <= 0) {
                    e.target.setCustomValidity('Value must be greater than 0');
                }
            });
        }
    });

    // Character limit validation for remarks field (100 characters)
    function validateRemarksCharacterLimit(input) {
        const maxLength = 100;
        if (input.value.length > maxLength) {
            input.value = input.value.substring(0, maxLength);
        }
    }

    // Apply character limit to remarks field
    const remarksField = document.getElementById('id_remarks');
    if (remarksField) {
        remarksField.addEventListener('input', function(e) {
            validateRemarksCharacterLimit(e.target);
        });
    }

    // Date validation for harvest_date (limit year to 4 digits)
    const harvestDateInput = document.getElementById('id_harvest_date');
    if (harvestDateInput) {
        harvestDateInput.addEventListener('input', function() {
            const value = this.value;
            if (value) {
                const dateParts = value.split('-');
                // Limit year to 4 digits
                if (dateParts[0] && dateParts[0].length > 4) {
                    dateParts[0] = dateParts[0].substring(0, 4);
                    this.value = dateParts.join('-');
                }
            }
        });
    }

    
    // confirmation ng form
    const form = document.getElementById("harvest-record-form");
    if (form) {
        form.addEventListener("submit", function (e) {
            const message = "Click 'OK' if all the input details are correct and accurate.\nPindutin ang 'OK' kung tama lahat ng detalye.";
            if (!confirm(message)) {
                e.preventDefault();
            }
        });
    }

    // Commodity type dropdown logic
    const commoditySelect = document.getElementById('id_commodity_id');
    const customInput = document.getElementById('id_commodity_custom');
    function toggleCustomInput() {
        if (commoditySelect && customInput) {
            if (commoditySelect.value === "1") {
                customInput.disabled = false;
                customInput.required = true;
            } else {
                customInput.disabled = true;
                customInput.required = false;
                customInput.value = '';
            }
        }
    }
    if (commoditySelect) {
        toggleCustomInput();
        commoditySelect.addEventListener('change', toggleCustomInput);
    }

    // Location type dropdown logic
    const locationTypeRadios = document.getElementsByName('location_type');
    const farmLandSelect = document.getElementById('id_farm_land');
    const municipalitySelect = document.getElementById('id_manual_municipality');
    const barangaySelect = document.getElementById('id_manual_barangay');

    function toggleLocationFields() {
        let selectedValue = '';
        locationTypeRadios.forEach(radio => {
            if (radio.checked) selectedValue = radio.value;
        });

        if (selectedValue === 'farm_land') {
            if (farmLandSelect) {
                farmLandSelect.disabled = false;
                farmLandSelect.required = true;
            }
            if (municipalitySelect) {
                municipalitySelect.disabled = true;
                municipalitySelect.required = false;
                municipalitySelect.value = '';
            }
            if (barangaySelect) {
                barangaySelect.disabled = true;
                barangaySelect.required = false;
                barangaySelect.value = '';
                barangaySelect.innerHTML = '<option value="">Select a municipality first</option>';
            }
        } else if (selectedValue === 'manual') {
            if (farmLandSelect) {
                farmLandSelect.disabled = true;
                farmLandSelect.required = false;
                farmLandSelect.value = '';
            }
            if (municipalitySelect) {
                municipalitySelect.disabled = false;
                municipalitySelect.required = true;
            }
            if (barangaySelect) {
                barangaySelect.disabled = !municipalitySelect.value;
                barangaySelect.required = true;
                if (!municipalitySelect.value) {
                    barangaySelect.innerHTML = '<option value="">Select a municipality first</option>';
                }
            }
        } else {
            // No location type selected - disable all
            if (farmLandSelect) {
                farmLandSelect.disabled = true;
                farmLandSelect.required = false;
                farmLandSelect.value = '';
            }
            if (municipalitySelect) {
                municipalitySelect.disabled = true;
                municipalitySelect.required = false;
                municipalitySelect.value = '';
            }
            if (barangaySelect) {
                barangaySelect.disabled = true;
                barangaySelect.required = false;
                barangaySelect.value = '';
                barangaySelect.innerHTML = '<option value="">Select a municipality first</option>';
            }
        }
    }
    
    // Initialize all fields to disabled state first
    if (farmLandSelect) {
        farmLandSelect.disabled = true;
        farmLandSelect.required = false;
    }
    if (municipalitySelect) {
        municipalitySelect.disabled = true;
        municipalitySelect.required = false;
    }
    if (barangaySelect) {
        barangaySelect.disabled = true;
        barangaySelect.required = false;
    }
    
    // Then apply the correct state based on current selection
    toggleLocationFields();
    locationTypeRadios.forEach(radio => {
        radio.addEventListener('change', toggleLocationFields);
    });

    // Municipality/Barangay logic
    if (municipalitySelect && barangaySelect) {
        municipalitySelect.addEventListener('change', function () {
            const municipalityId = this.value;
            barangaySelect.innerHTML = '';
            barangaySelect.disabled = true;

            if (municipalityId) {
                fetch(`/get-barangays/${municipalityId}/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length > 0) {
                            barangaySelect.disabled = false;
                            barangaySelect.innerHTML = '<option value="">Select Barangay</option>';
                            data.forEach(barangay => {
                                const option = document.createElement('option');
                                option.value = barangay.id;
                                option.textContent = barangay.barangay;
                                barangaySelect.appendChild(option);
                            });
                        } else {
                            barangaySelect.innerHTML = '<option value="">No Barangays available</option>';
                            barangaySelect.disabled = true;
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching barangays:', error);
                        barangaySelect.innerHTML = '<option value="">Error loading barangays</option>';
                        barangaySelect.disabled = true;
                    });
            } else {
                barangaySelect.innerHTML = '<option value="">Select a municipality first</option>';
                barangaySelect.disabled = true;
            }
        });
    }
});
</script>
{% endblock content %}
