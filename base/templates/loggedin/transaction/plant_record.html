{%load static%}

{% block content %}
<div class="container p-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-success fw-bold mb-1">
                <i class="bi bi-plus-circle me-2"></i>Create New Plant Record
            </h2>
            <p class="text-muted mb-0">Add planting information to your agricultural records</p>
        </div>
    </div>

    <!-- Information Alert -->
    <div class="alert alert-warning border-0 mb-4">
        <div class="d-flex align-items-center">
            <i class="bi bi-info-circle text-warning me-3 fs-5"></i>
            <p class="mb-0 small">
                <strong>Note:</strong> Proceeding with Record does not mean the record has been saved in the database. 
                Proceed with Record and Complete the Transaction to successfully submit the record.
            </p>
        </div>
    </div>

    <form method="POST" novalidate id="plant-record-form">
        {% csrf_token %}
        <div class="row g-3">
            {% for field in form %}
                <div class="col-md-6">
                    <label class="form-label">{{ field.label_tag }}</label>
                    {{ field }}
                    {% if field.errors %}
                        <div class="text-danger small mt-1">{{ field.errors }}</div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>

        <!-- Location Section -->
        <div class="mt-4 pt-3 border-top">
            <h5 class="text-success mb-3">
                <i class="bi bi-geo-alt me-2"></i>Location Information
            </h5>
            <div class="alert alert-warning border-0 mb-3">
                <p class="mb-0 small">
                    <i class="bi bi-lightbulb me-1"></i>
                    If you own a farm land that you would like to use for your records, you should first 
                    <a href="{% url 'base:farmland_record' %}" class="alert-link" style="text-decoration: underline;">set up your farm land information here</a> 
                    before creating a plant record.
                </p>
            </div>
            
            <div class="row g-3">
                {% for field in transaction_form %}
                {% if field.name != "manual_barangay" and field.name != "manual_municipality" %}
                    <div class="col-md-6">
                        <label class="form-label">{{ field.label_tag }}</label>
                        {{ field }}
                        {% if field.errors %}
                            <div class="text-danger small mt-1">{{ field.errors }}</div>
                        {% endif %}
                    </div>
                {% endif %}
                {% endfor %}
                <div class="col-md-6">
                    <label class="form-label" for="id_manual_municipality">Municipality</label>
                    {{ transaction_form.manual_municipality }}
                </div>
                <div class="col-md-6">
                    <label class="form-label" for="id_manual_barangay">Barangay</label>
                    <select name="manual_barangay" id="id_manual_barangay" class="form-select" disabled>
                        <option value="">Select a municipality first</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mt-4 pt-3 border-top">
            <button type="submit" class="btn btn-success">
                <i class="bi bi-check-circle me-2"></i>Proceed with Record
            </button>
            
            <div class="d-flex flex-wrap gap-2">
                {% if from_transaction %}
                    <a href="{% url 'base:newrecord' %}?view=transaction_list" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>Back to Transaction
                    </a>
                {%elif from_transactionedit %}
                    <a href="{% url 'base:newrecord' %}?view=transaction_list" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle me-2"></i>Cancel Edit
                    </a>
                {% else %}
                    <a href="{% url 'base:newrecord' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle me-2"></i>Cancel
                    </a>
                {% endif %}
            </div>
        </div> 
    </form>
</div>
<script>

    document.addEventListener('DOMContentLoaded', function() {
    
    // Numeric input validation for decimal fields
    function validateNumericInput(input) {
        let value = input.value;
        
        // Remove any non-numeric characters except decimal point
        value = value.replace(/[^0-9.]/g, '');
        
        // Ensure only one decimal point
        let parts = value.split('.');
        if (parts.length > 2) {
            value = parts[0] + '.' + parts.slice(1).join('');
        }
        
        // Limit to 10 digits before decimal and 2 after
        if (parts.length === 2) {
            parts[0] = parts[0].substring(0, 10);
            parts[1] = parts[1].substring(0, 2);
            value = parts[0] + '.' + parts[1];
        } else {
            value = value.substring(0, 10);
        }
        
        input.value = value;
        
        // Validate minimum value
        if (parseFloat(value) < 0.01 && value !== '') {
            input.setCustomValidity('Value must be at least 0.01');
        } else {
            input.setCustomValidity('');
        }
    }

    // Apply numeric validation to harvest fields
    const numericFields = ['id_min_expected_harvest', 'id_max_expected_harvest'];
    numericFields.forEach(function(fieldId) {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', function(e) {
                validateNumericInput(e.target);
            });
            
            field.addEventListener('blur', function(e) {
                // Ensure minimum value on blur
                if (e.target.value && parseFloat(e.target.value) < 0.01) {
                    e.target.value = '0.01';
                }
            });
        }
    });
    
    // Confirmation on submit
    const form = document.getElementById("plant-record-form");
    if (form) {
        form.addEventListener("submit", function (e) {
            // Validate harvest amounts before submission
            const minHarvest = document.getElementById('id_min_expected_harvest');
            const maxHarvest = document.getElementById('id_max_expected_harvest');
            
            if (minHarvest && maxHarvest) {
                const minValue = parseFloat(minHarvest.value);
                const maxValue = parseFloat(maxHarvest.value);
                
                if (minValue > maxValue) {
                    alert('Minimum expected harvest cannot be greater than maximum expected harvest.');
                    e.preventDefault();
                    minHarvest.focus();
                    return false;
                }
            }
            
            const message = "Click 'OK' if all the input details are correct and accurate.\nPindutin ang 'OK' kung tama lahat ng detalye.";
            if (!confirm(message)) {
                e.preventDefault();
            }
        });
    }

    // Commodity type dropdown logic
    const commoditySelect = document.getElementById('id_commodity_id');
    const customInput = document.getElementById('id_commodity_custom');
    function toggleCustomInput() {
        if (commoditySelect && customInput) {
            if (commoditySelect.value === "1") {
                customInput.disabled = false;
                customInput.required = true;
            } else {
                customInput.disabled = true;
                customInput.required = false;
                customInput.value = '';
            }
        }
    }
    if (commoditySelect) {
        toggleCustomInput();
        commoditySelect.addEventListener('change', toggleCustomInput);
    }

    // Location type dropdown logic
    const locationTypeRadios = document.getElementsByName('location_type');
    const farmLandSelect = document.getElementById('id_farm_land');
    const municipalitySelect = document.getElementById('id_manual_municipality');
    const barangaySelect = document.getElementById('id_manual_barangay');

    function toggleLocationFields() {
        let selectedValue = '';
        locationTypeRadios.forEach(radio => {
            if (radio.checked) selectedValue = radio.value;
        });

        if (selectedValue === 'farm_land') {
            if (farmLandSelect) {
                farmLandSelect.disabled = false;
                farmLandSelect.required = true;
            }
            if (municipalitySelect) {
                municipalitySelect.disabled = true;
                municipalitySelect.required = false;
                municipalitySelect.value = '';
            }
            if (barangaySelect) {
                barangaySelect.disabled = true;
                barangaySelect.required = false;
                barangaySelect.value = '';
            }
        } else if (selectedValue === 'manual') {
            if (farmLandSelect) {
                farmLandSelect.disabled = true;
                farmLandSelect.required = false;
                farmLandSelect.value = '';
            }
            if (municipalitySelect) {
                municipalitySelect.disabled = false;
                municipalitySelect.required = true;
            }
            if (barangaySelect) {
                barangaySelect.disabled = !municipalitySelect.value;
                barangaySelect.required = true;
            }
        } else {
            if (farmLandSelect) {
                farmLandSelect.disabled = true;
                farmLandSelect.required = false;
                farmLandSelect.value = '';
            }
            if (municipalitySelect) {
                municipalitySelect.disabled = true;
                municipalitySelect.required = false;
                municipalitySelect.value = '';
            }
            if (barangaySelect) {
                barangaySelect.disabled = true;
                barangaySelect.required = false;
                barangaySelect.value = '';
            }
            }
        }
    }
    toggleLocationFields();
    locationTypeRadios.forEach(radio => {
        radio.addEventListener('change', toggleLocationFields);
    });

    // Municipality/Barangay logic
    if (municipalitySelect && barangaySelect) {
        municipalitySelect.addEventListener('change', function () {
            const municipalityId = this.value;
            barangaySelect.innerHTML = '';
            barangaySelect.disabled = true;

            if (municipalityId) {
                fetch(`/get-barangays/${municipalityId}/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length > 0) {
                            barangaySelect.disabled = false;
                            barangaySelect.innerHTML = '<option value="">Select Barangay</option>';
                            data.forEach(barangay => {
                                const option = document.createElement('option');
                                option.value = barangay.id;
                                option.textContent = barangay.barangay;
                                barangaySelect.appendChild(option);
                            });
                        } else {
                            barangaySelect.innerHTML = '<option value="">No Barangays available</option>';
                            barangaySelect.disabled = true;
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching barangays:', error);
                        barangaySelect.innerHTML = '<option value="">Error loading barangays</option>';
                        barangaySelect.disabled = true;
                    });
            } else {
                barangaySelect.innerHTML = '<option value="">Select a municipality first</option>';
                barangaySelect.disabled = true;
            }
        });
    }
});

    {% comment %} INITIAL
    // confirmation ng form
    document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById("plant-record-form");
    form.addEventListener("submit", function (e) {
        const message = "Click 'OK' if all the input details are correct and accurate.\nPindutin ang 'OK' kung tama lahat ng detalye.";
        if (!confirm(message)) {
        e.preventDefault();
        }
    });
    });

    // commodity type dropdown
    document.addEventListener('DOMContentLoaded', function() {
        const commoditySelect = document.getElementById('id_commodity_id');
        const customInput = document.getElementById('id_commodity_custom');

        function toggleCustomInput() {
            if (commoditySelect.value === "1") { // pk=1 for 'Not Listed'
                customInput.disabled = false;
                customInput.required = true;
            } else {
                customInput.disabled = true;
                customInput.required = false;
                customInput.value = '';
            }
        }

        // Initial state
        toggleCustomInput();

        // Listen for changes
        commoditySelect.addEventListener('change', toggleCustomInput);
    });

    //location type dropdown
    document.addEventListener('DOMContentLoaded', function() {
        // Get references to the location type radios and dropdowns
        const locationTypeRadios = document.getElementsByName('location_type');
        const farmLandSelect = document.getElementById('id_farm_land');
        const municipalitySelect = document.getElementById('id_manual_municipality');
        const barangaySelect = document.getElementById('id_manual_barangay');

        function toggleLocationFields() {
            let selectedValue = '';
            locationTypeRadios.forEach(radio => {
                if (radio.checked) selectedValue = radio.value;
            });

            if (selectedValue === 'farm_land') {
                farmLandSelect.disabled = false;
                municipalitySelect.disabled = true;
                barangaySelect.disabled = true;
            } else if (selectedValue === 'manual') {
                farmLandSelect.disabled = true;
                municipalitySelect.disabled = false;
                barangaySelect.disabled = true;
                municipalitySelect.addEventListener('change', function () {
                    const municipalityId = this.value;
                    barangaySelect.innerHTML = '';
                    barangaySelect.disabled = true;

                    if (municipalityId) {
                    fetch(`/get-barangays/${municipalityId}/`)
                        .then(response => response.json())
                        .then(data => {
                        if (data.length > 0) {
                            barangaySelect.disabled = false;
                            barangaySelect.innerHTML = '<option value="">Select Barangay</option>';
                            data.forEach(barangay => {
                            const option = document.createElement('option');
                            option.value = barangay.id;
                            option.textContent = barangay.barangay;
                            barangaySelect.appendChild(option);
                            });
                        }
                        });
                    } else {
                        barangaySelect.innerHTML = '<option value="">No Barangays available</option>';
                        barangaySelect.disabled = true;
                    } else {
                    barangaySelect.innerHTML = '<option value="">Select a municipality first</option>';
                    }
                });
            } else {
                // Default: enable all
                farmLandSelect.disabled = true;
                municipalitySelect.disabled = true;
                barangaySelect.disabled = true;
            }
        }
        

        // Initial state
        toggleLocationFields();

        // Add event listeners to all location type radios
        locationTypeRadios.forEach(radio => {
            radio.addEventListener('change', toggleLocationFields);
        });
    });



    // Initialize the map
    var map = L.map('map').setView([14.678, 120.536], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

    // Load GeoJSON (this is just a placeholder URL; change to your static path or Django endpoint)
    {% comment %} FROM HERE
    let selectedLayer = null;
    var mapData = {{ map_data|safe }}; // Ensure this is passed correctly in the context

    fetch("{% static 'geojson/Barangays.json' %}")
    .then(response => response.json())
    .then(geojsonData => {
        const geojson = L.geoJSON(geojsonData, {
            style: {
                color: "#3388ff",
                weight: 1,
                fillOpacity: 0.3
            },
                onEachFeature: function (feature, layer) {
                var barangayName = feature.properties.NAME_3;
                var municipalityName = feature.properties.NAME_2;
                var provinceName = feature.properties.PROVINCE;

                // Find forecast data for the barangay
                var forecastedData = mapData.find(item => 
                    item.harvest_barangay === barangayName && item.harvest_municipality === municipalityName);

                var forecastedAmount = forecastedData ? forecastedData.forecasted_amount : 0;

                layer.bindPopup(
                    `<b>${barangayName}</b><br>` +
                    `Municipality: ${municipalityName}<br>` +
                    `Province: ${provinceName}<br>` +
                    `Forecasted Amount: ${forecastedAmount.toFixed(2)} kg`
                );
                TO HERE 
    
    let selectedLayer = null;

    fetch("{% static 'geojson/Barangays.json' %}")
    .then(response => response.json())
    .then(geojsonData => {
        const geojson = L.geoJSON(geojsonData, {
            style: {
                color: "#3388ff",
                weight: 1,
                fillOpacity: 0.3
            },
                onEachFeature: function (feature, layer) {
                    layer.on('click', function () {
                        if (selectedLayer) {
                            geojson.resetStyle(selectedLayer);
                        }

                        selectedLayer = layer;

                        layer.setStyle({ fillOpacity: 0.5, color: "#ff7800" });

                        document.getElementById('plant_barangay').value = feature.properties.NAME_3;
                        console.log(feature.properties.NAME_3)
                    });

                    /**layer.bindTooltip(barangayName, {
                    
                });**/

                    layer.bindTooltip(feature.properties.NAME_3, { 
                        sticky: true,
                        //permanent: true,
                        direction: "center",
                        className: "barangay-label"
                     }); // Optional: show name    
            }
        }).addTo(map);
    })
    .catch(error => {
        console.error('Error loading GeoJSON:', error);
    });

    // Add markers from mapData

    mapData.forEach(function(item) {
        if (item.latitude && item.longitude) { // Only add markers if valid coordinates
            var marker = L.marker([item.latitude, item.longitude]).addTo(map);
            marker.bindPopup('<b>' + item.harvest_barangay + '</b><br>' + item.harvest_municipality + '<br>Forecasted Amount: ' + item.forecasted_amount.toFixed(2) + ' kg');
        } else {
            console.warn('Invalid coordinates for marker:', item);
        }
    }); 
    {% endcomment %}
</script>
{% comment %} <script>
    var map = L.map('map').setView([14.6781, 120.5395], 10); // center at Bataan

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    var marker;

    map.on('click', function(e) {
        var lat = e.latlng.lat;
        var lng = e.latlng.lng;

        if (marker) {
            marker.setLatLng(e.latlng);
        } else {
            marker = L.marker(e.latlng).addTo(map);
        }

        // Update hidden fields
        document.getElementById('latitude').value = lat;
        document.getElementById('longitude').value = lng;
    });
    
    
</script> {% endcomment %}

{% endblock content %}
