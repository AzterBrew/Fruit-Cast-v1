{% extends "loggedin/layout.html" %}

{% block title %}
Fruit Cast | Home
{% endblock title %}

{% block content %}
<div class="main-user">

    <div class="main-user-content justify-content-center">
        {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
                <i class="bi bi-success-circle me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        {% endif %}
        {% comment %} <div class="col-lg-8"> {% endcomment %}
            <div class="card shadow-sm rounded-4 p-4 mb-4 text-center" style="background: #fffefc;">
                <h1 class="mb-3 text-success fw-bold">Welcome to Fruit Cast, {{ user_firstname }}</h1>
                <p class="lead mb-4">Your partner in forecasting and monitoring Bataan's fruit supply.</p>
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body d-flex flex-column justify-content-center align-items-center">
                                <h3 class="card-title mb-3"><i class="bi bi-bar-chart-line text-success me-2"></i>Forecast</h3>
                                <p class="card-text mb-3">Check out the current forecast of Bataan's fruit supply for the next year.</p>
                                <a class="btn btn-success" href="{% url 'dashboard:forecast' %}"><b>Go to Forecast</b></a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body d-flex flex-column justify-content-center align-items-center">
                                <h3 class="card-title mb-3"><i class="bi bi-graph-up-arrow text-success me-2"></i>Monitor</h3>
                                <p class="card-text mb-3">See the current status of the recorded fruit supply in Bataan based on our data.</p>
                                <a class="btn btn-success" href="{% url 'dashboard:monitor' %}"><b>Go to Monitor</b></a>
                            </div>
                        </div>
                    </div>
                </div>
                <hr class="my-4">
                <div>
                    <p class="mb-2">Ready to record your own fruit transactions?</p>
                    <a class="btn btn-outline-success" href="{% url 'base:newrecord' %}">
                        <i class="bi bi-journal-plus me-2"></i>Start a New Record
                    </a>
                </div>
                <hr>
                <div class="row justify-content-center">
                <div class="col-lg-10 mt-4">
                    <h2 id="recommendations-heading" class="mb-4 text-success fw-bold text-center">
                        <i class="bi bi-lightbulb-fill me-2"></i>
                        Recommended Fruits to Plant on {{ now|date:"F Y" }}
                    </h2>
                    <form id="recommendations-form" class="mb-4 d-flex justify-content-center align-items-center flex-wrap">
                        <select id="month-select" class="form-select w-auto me-2 mb-2">
                            {% for month in months %}
                                <option value="{{ month.number }}" {% if month.number == now.month %}selected{% endif %}>{{ month.name }}</option>
                            {% endfor %}
                        </select>
                        <select id="year-select" class="form-select w-auto me-2 mb-2">
                            {% for year in years %}
                                <option value="{{ year }}" {% if year == now.year %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                        <select id="municipality-select" class="form-select w-auto me-2 mb-2">
                            <option value="14">All Municipalities</option>
                            {% for municipality in municipalities %}
                                <option value="{{ municipality.municipality_id }}">{{ municipality.municipality }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-success mb-2">Apply Filter</button>
                    </form>
                    <div id="recommendations-container" class="text-center mx-auto" style="max-width: 900px;">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Fetching recommendations. This may take a moment...</p>
                    </div>
                </div>
            </div>
        </div>
        {% comment %} </div> {% endcomment %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const recommendationsForm = document.getElementById('recommendations-form');
    const recommendationsContainer = document.getElementById('recommendations-container');
    const monthSelect = document.getElementById('month-select');
    const yearSelect = document.getElementById('year-select');
    const municipalitySelect = document.getElementById('municipality-select');

    function fetchRecommendations() {
        const selectedMonth = monthSelect.value;
        const selectedYear = yearSelect.value;
        const selectedMunicipality = municipalitySelect.value;
        const url = `/api/get-recommendations/?month=${selectedMonth}&year=${selectedYear}&municipality_id=${selectedMunicipality}`;

        recommendationsContainer.innerHTML = `
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Fetching recommendations. This may take a moment...</p>
        `;

        const heading = document.getElementById('recommendations-heading');
        const monthName = monthSelect.options[monthSelect.selectedIndex].text;
        const municipalityName = municipalitySelect.options[municipalitySelect.selectedIndex].text;
        
        let headingText = `Recommended Fruits to Plant on ${monthName} ${yearSelect.value}`;
        if (municipalityName !== 'All Municipalities') {
            headingText += ` in ${municipalityName}`;
        }
        heading.innerHTML = `<i class="bi bi-lightbulb-fill me-2"></i>${headingText}`;

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    let errorMessage = 'Failed to load recommendations. Please try again later.';
                    
                    // Provide more specific error messages based on the error content
                    if (data.error.includes('timeout') || data.error.includes('timed out')) {
                        errorMessage = 'Request timed out. The recommendation service is taking longer than expected. Please try again.';
                    } else if (data.error.includes('connection') || data.error.includes('network')) {
                        errorMessage = 'Connection error. Please check your internet connection and try again.';
                    } else if (data.error.includes('Service temporarily unavailable')) {
                        errorMessage = 'The recommendation service is temporarily unavailable. Please try again in a few minutes.';
                    }
                    
                    recommendationsContainer.innerHTML = `
                        <div class="alert alert-warning" role="alert">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Notice:</strong> ${errorMessage}
                            <br><small class="text-muted mt-2 d-block">
                                You can still browse forecasts and record transactions while we work on this.
                            </small>
                        </div>
                    `;
                    console.error('API Error:', data.error);
                    
                    // If there are backup recommendations, show them
                    if (data.short_term || data.long_term) {
                        let html = '<div class="mt-3"><h6>Available recommendations:</h6>';
                        
                        if (data.short_term && data.short_term.length > 0) {
                            html += '<div class="mb-3"><strong>Short-term:</strong><ul>';
                            data.short_term.forEach(rec => {
                                html += `<li>${rec.commodity_name}</li>`;
                            });
                            html += '</ul></div>';
                        }
                        
                        if (data.long_term && data.long_term.length > 0) {
                            html += '<div><strong>Long-term:</strong><ul>';
                            data.long_term.forEach(rec => {
                                html += `<li>${rec.commodity_name}</li>`;
                            });
                            html += '</ul></div>';
                        }
                        
                        html += '</div>';
                        recommendationsContainer.innerHTML += html;
                    }
                } else {
                    let html = '';

                    // Short-Term Recommendations
                    if (data.short_term && data.short_term.length > 0) {
                        html += `
                            <div class="mb-4">
                                <h4 class="text-success"><i class="bi bi-hourglass-split me-2"></i>Short-Term (Matures in months)</h4>
                                <div class="row g-3">
                        `;
                        data.short_term.forEach(rec => {
                            html += `
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h5 class="card-title fw-bold">${rec.commodity_name}</h5>
                                            <p class="card-text">${rec.reason}</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += `</div></div>`;
                    } else {
                        html += `
                            <div class="mb-4">
                                <h4 class="text-success"><i class="bi bi-hourglass-split me-2"></i>Short-Term (Matures in months)</h4>
                                <p>Currently no recommended fruits to plant for short term</p>
                            </div>
                        `;
                    }

                    // Long-Term Recommendations
                    if (data.long_term && data.long_term.length > 0) {
                        html += `
                            <div>
                                <h4 class="text-success"><i class="bi bi-tree-fill me-2"></i>Long-Term (Matures in years)</h4>
                                <div class="row g-3">
                        `;
                        data.long_term.forEach(rec => {
                            html += `
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h5 class="card-title fw-bold">${rec.commodity_name}</h5>
                                            <p class="card-text">${rec.reason}</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += `</div></div>`;
                    } else {
                        html += `
                            <div>
                                <h4 class="text-success"><i class="bi bi-tree-fill me-2"></i>Long-Term (Matures in years)</h4>
                                <p>Currently no recommended fruits to plant for long term</p>
                            </div>
                        `;
                    }

                    if (html === '') {
                        html = '<p class="lead text-muted">No new planting recommendations at this time.</p>';
                    }

                    recommendationsContainer.innerHTML = html;
                }
            })
            .catch(error => {
                let errorMessage = 'A network error occurred. Please check your connection and try again.';
                
                if (error.message.includes('timeout')) {
                    errorMessage = 'Request timed out. Please try again.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Unable to connect to the server. Please check your internet connection.';
                } else if (error.message.includes('HTTP 5')) {
                    errorMessage = 'Server error occurred. Please try again in a few minutes.';
                }
                
                recommendationsContainer.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <i class="bi bi-exclamation-circle me-2"></i>
                        <strong>Connection Error:</strong> ${errorMessage}
                        <br><small class="text-muted mt-2 d-block">
                            <button class="btn btn-sm btn-outline-primary mt-2" onclick="fetchRecommendations()">
                                <i class="bi bi-arrow-clockwise me-1"></i>Try Again
                            </button>
                        </small>
                    </div>
                `;
                console.error('Fetch Error:', error);
            });
    }
    
    // Make fetchRecommendations available globally for retry button
    window.fetchRecommendations = fetchRecommendations;
    
    // Initial fetch on page load
    fetchRecommendations();

    // Event listener for the form submission
    recommendationsForm.addEventListener('submit', function(event) {
        event.preventDefault();
        fetchRecommendations();
    });
});
</script>
{% endblock content %}