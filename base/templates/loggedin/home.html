{% extends "loggedin/layout.html" %}

{% block title %}
Fruit Cast | Home
{% endblock title %}

{% block navbar %}
    {% include "loggedin/navbar.html" %}
{% endblock navbar %}

{% block content %}
<div class="main-user py-5">

    <div class="row main-user-content justify-content-center">
        {% comment %} <div class="col-lg-8"> {% endcomment %}
            <div class="card shadow-sm rounded-4 p-4 mb-4 text-center" style="background: #fffefc;">
                <h1 class="mb-3 text-success fw-bold">Welcome to Fruit Cast, {{ user_firstname }}</h1>
                <p class="lead mb-4">Your partner in forecasting and monitoring Bataan's fruit supply.</p>
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body d-flex flex-column justify-content-center align-items-center">
                                <h3 class="card-title mb-3"><i class="bi bi-bar-chart-line text-success me-2"></i>Forecast</h3>
                                <p class="card-text mb-3">Check out the current forecast of Bataan's fruit supply for the next year.</p>
                                <a class="btn btn-success" href="{% url 'dashboard:forecast' %}"><b>Go to Forecast</b></a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body d-flex flex-column justify-content-center align-items-center">
                                <h3 class="card-title mb-3"><i class="bi bi-graph-up-arrow text-success me-2"></i>Monitor</h3>
                                <p class="card-text mb-3">See the current status of the recorded fruit supply in Bataan based on our data.</p>
                                <a class="btn btn-success" href="{% url 'dashboard:monitor' %}"><b>Go to Monitor</b></a>
                            </div>
                        </div>
                    </div>
                </div>
                <hr class="my-4">
                <div>
                    <p class="mb-2">Ready to record your own fruit transactions?</p>
                    <a class="btn btn-outline-success" href="{% url 'base:newrecord' %}?view=choose">
                        <i class="bi bi-journal-plus me-2"></i>Start a New Record
                    </a>
                </div>
            </div>
        </div>
        <div class="main-user py-5">
    <div class="col-lg-10 mt-4">
        <div class="card shadow-sm rounded-4 p-4" style="background: #fffefc;">
            <h2 class="mb-4 text-success fw-bold text-center"><i class="bi bi-lightbulb-fill me-2"></i>Recommended Crops to Plant</h2>
            <div id="recommendations-container" class="text-center">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Fetching recommendations. This may take a moment...</p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const recommendationsContainer = document.getElementById('recommendations-container');

    // Make an asynchronous request to the new API endpoint
    fetch('/api/get-recommendations/')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                // Display an error message if the API call failed
                recommendationsContainer.innerHTML = '<p class="text-danger">Failed to load recommendations. Please try again later.</p>';
                console.error('API Error:', data.error);
            } else {
                // Build the HTML for the recommendations
                let html = '';

                if (data.short_term && data.short_term.length > 0) {
                    html += `
                        <div class="mb-4">
                            <h4 class="text-success"><i class="bi bi-hourglass-split me-2"></i>Short-Term (Matures in months)</h4>
                            <div class="row g-3">
                    `;
                    data.short_term.forEach(rec => {
                        html += `
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h5 class="card-title fw-bold">${rec.commodity_name}</h5>
                                        <p class="card-text">${rec.reason}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += `</div></div>`;
                }

                if (data.long_term && data.long_term.length > 0) {
                    html += `
                        <div>
                            <h4 class="text-success"><i class="bi bi-tree-fill me-2"></i>Long-Term (Matures in years)</h4>
                            <div class="row g-3">
                    `;
                    data.long_term.forEach(rec => {
                        html += `
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h5 class="card-title fw-bold">${rec.commodity_name}</h5>
                                        <p class="card-text">${rec.reason}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += `</div></div>`;
                }
                
                // If no recommendations are available
                if (html === '') {
                    html = '<p class="lead text-muted">No new planting recommendations at this time.</p>';
                }
                
                recommendationsContainer.innerHTML = html;
            }
        })
        .catch(error => {
            // Handle network or other fetch-related errors
            recommendationsContainer.innerHTML = '<p class="text-danger">A network error occurred. Please check your connection.</p>';
            console.error('Fetch Error:', error);
        });
});
</script>
{% endblock content %}