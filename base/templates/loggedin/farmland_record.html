{% load static %}
{% block content %}
<div class="container p-4">

        <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-success fw-bold mb-1">
                <i class="bi bi-tree me-2"></i>
                {% if farmland %}Edit Farmland{% else %}Add New Farmland{% endif %}
            </h2>
            {% if total_farmlands %}
            <span class="badge bg-succcess">
                <i class="bi bi-geo-alt me-1"></i>{{ total_farmlands }} farmland{{ total_farmlands|pluralize }} registered
            </span>
            {% endif %}
            <p class="text-muted mb-0">
                {% if farmland %}
                    Update your farmland information
                {% else %}
                    Register a new farmland for your agricultural records
                {% endif %}
            </p>
        </div>
        
    </div>

    <!-- Information Alert -->
    <div class="alert alert-warning border-0 mb-4">
        <div class="d-flex align-items-center">
            <i class="bi bi-info-circle text-warning me-3 fs-4"></i>
            <div>
                <h6 class="mb-1 fw-semibold">Why register farmlands?</h6>
                <p class="mb-0 small">Registering your farmlands helps you easily select locations for plant and harvest records, making record-keeping more efficient and organized.</p>
            </div>
        </div>
    </div>

    <!-- Form Section -->
    <form method="POST" novalidate id="farmland-record-form">
        {% csrf_token %}
        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label" for="{{ form.farmland_name.id_for_label }}">
                    <i class="bi bi-tag me-1"></i>{{ form.farmland_name.label }}
                </label>
                {{ form.farmland_name }}
                {% if form.farmland_name.errors %}
                    <div class="text-danger small mt-1">{{ form.farmland_name.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6">
                <label class="form-label" for="{{ form.estimated_area.id_for_label }}">
                    <i class="bi bi-rulers me-1"></i>{{ form.estimated_area.label }}
                </label>
                {{ form.estimated_area }}
                {% if form.estimated_area.errors %}
                    <div class="text-danger small mt-1">{{ form.estimated_area.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6">
                <label class="form-label" for="{{ form.municipality.id_for_label }}">
                    <i class="bi bi-geo-alt me-1"></i>{{ form.municipality.label }}
                </label>
                {{ form.municipality }}
                {% if form.municipality.errors %}
                    <div class="text-danger small mt-1">{{ form.municipality.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6">
                <label class="form-label" for="{{ form.barangay.id_for_label }}">
                    <i class="bi bi-map me-1"></i>{{ form.barangay.label }}
                </label>
                {{ form.barangay }}
                {% if form.barangay.errors %}
                    <div class="text-danger small mt-1">{{ form.barangay.errors }}</div>
                {% endif %}
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mt-4 pt-3 border-top">
            <div class="d-flex flex-wrap gap-2">
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-check-circle me-2"></i>
                    {% if farmland %}Update Farmland{% else %}Save Farmland{% endif %}
                </button>
                
                {% if farmland %}
                    <a href="{% url 'base:farmland_owned' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>Cancel
                    </a>
                {% else %}
                    <a href="{% url 'base:newrecord' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle me-2"></i>Cancel
                    </a>
                {% endif %}
            </div>
 
            {% if not farmland %}
                <a href="{% url 'base:farmland_owned' %}" class="btn btn-secondary">
                    <i class="bi bi-list me-2"></i>View All Farmlands
                </a>
            {% endif %}
        </div>
    </form>

    <!-- Help Section -->
    {% if not farmland %}
    <div class="card border-warning mt-4">
        <div class="card-body">
            <h6 class="card-title text-warning">
                <i class="bi bi-lightbulb me-2"></i>Pro Tips
            </h6>
            <ul class="mb-0 small text-muted">
                <li>Use descriptive names like "North Rice Field" or "Mango Orchard 1" for easy identification</li>
                <li>Estimated area helps with planning and record analysis (optional but recommended)</li>
                <li>You can edit farmland information anytime from your account panel</li>
            </ul>
        </div>
    </div>
    {% endif %}

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form validation and confirmation
    const form = document.getElementById("farmland-record-form");
    if (form) {
        form.addEventListener("submit", function (e) {
            const farmlandName = document.getElementById('id_farmland_name').value.trim();
            const municipality = document.getElementById('id_municipality').value;
            const barangay = document.getElementById('id_barangay').value;
            
            // Basic validation
            if (!farmlandName || !municipality || !barangay) {
                alert('Please fill in all required fields (Farmland Name, Municipality, and Barangay).');
                e.preventDefault();
                return;
            }
            
            const action = '{% if farmland %}update{% else %}save{% endif %}';
            const message = `Click 'OK' to ${action} this farmland record.\nPindutin ang 'OK' para i-${action} ang farmland record.`;
            if (!confirm(message)) {
                e.preventDefault();
            }
        });
    }

    // Municipality and barangay dynamic selection
    const municipalitySelect = document.getElementById('id_municipality');
    const barangaySelect = document.getElementById('id_barangay');

    // Store the initial selected barangay (for edit mode)
    let initialBarangay = barangaySelect ? barangaySelect.getAttribute('data-initial') || barangaySelect.value : null;

    function updateBarangayOptions(keepSelected = false) {
        const municipalityId = municipalitySelect.value;
        barangaySelect.innerHTML = '<option value="">Loading...</option>';
        barangaySelect.disabled = true;

        if (municipalityId) {
            fetch(`/get-barangays/${municipalityId}/`)
                .then(response => response.json())
                .then(data => {
                    barangaySelect.innerHTML = '';
                    if (data.length > 0) {
                        barangaySelect.disabled = false;
                        barangaySelect.innerHTML = '<option value="">Select Barangay</option>';
                        data.forEach(barangay => {
                            const option = document.createElement('option');
                            option.value = barangay.id;
                            option.textContent = barangay.barangay;
                            // If editing, select the correct barangay
                            if (
                                (keepSelected && barangay.id == initialBarangay) ||
                                (!keepSelected && barangay.id == barangaySelect.value)
                            ) {
                                option.selected = true;
                            }
                            barangaySelect.appendChild(option);
                        });
                    } else {
                        barangaySelect.innerHTML = '<option value="">No Barangays available</option>';
                        barangaySelect.disabled = true;
                    }
                })
                .catch(error => {
                    console.error('Error loading barangays:', error);
                    barangaySelect.innerHTML = '<option value="">Error loading barangays</option>';
                    barangaySelect.disabled = true;
                });
        } else {
            barangaySelect.innerHTML = '<option value="">Select a municipality first</option>';
            barangaySelect.disabled = true;
        }
    }

    if (municipalitySelect && barangaySelect) {
        municipalitySelect.addEventListener('change', function() {
            // On change, don't keep the old selection
            updateBarangayOptions(false);
        });
        // On page load, keep the initial selection (for edit mode)
        updateBarangayOptions(true);
    }

    // Simple validation to prevent negative values for estimated area field
    function preventNegativeInput(input) {
        let value = input.value;
        
        // Remove any non-numeric characters except decimal point
        value = value.replace(/[^0-9.]/g, '');
        
        // Ensure only one decimal point
        let parts = value.split('.');
        if (parts.length > 2) {
            value = parts[0] + '.' + parts.slice(1).join('');
        }
        
        input.value = value;
        
        // Validate minimum value (greater than zero)
        if (parseFloat(value) <= 0 && value !== '') {
            input.setCustomValidity('Value must be greater than 0');
        } else {
            input.setCustomValidity('');
        }
    }

    // Apply validation to estimated area field
    const estimatedAreaField = document.getElementById('id_estimated_area');
    if (estimatedAreaField) {
        estimatedAreaField.addEventListener('input', function(e) {
            preventNegativeInput(e.target);
        });
        
        estimatedAreaField.addEventListener('blur', function(e) {
            // Ensure minimum value on blur if field has value
            if (e.target.value && parseFloat(e.target.value) <= 0) {
                e.target.setCustomValidity('Value must be greater than 0');
            }
        });
    }
});
</script>
{% endblock content %}