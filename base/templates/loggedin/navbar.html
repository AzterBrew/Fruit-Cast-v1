{%load static%}

<header id="header" class="d-block navbar navbar-expand-lg shadow-sm fixed-top">
    <div class="container-fluid ">
        <!-- Sidebar Toggle and Logo -->
        <div class="bg-green-fc d-flex align-items-center">
            <button class="btn btn-outline-light me-3" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasguest" aria-controls="offcanvasguest">
                <i class="bi bi-list" style="font-size: 1.5rem;"></i>
            </button>
            <a class="navbar-brand d-flex align-items-center text-white" href="{% url 'base:home' %}">
                <img src="{% static 'images/logo/3.png' %}" alt="Fruit Cast Logo" style="max-height: 40px;" class="me-2">
                <span class="fw-bold">Fruit Cast</span>
            </a>
        </div>
        <!-- User Navigation -->
        <nav class="ms-auto bg-green-fc" aria-label="User">
            <ul class="navbar-nav d-flex flex-row align-items-center">
                <!-- Notifications -->
                <li class="nav-item me-3">
                    <a class="nav-link text-light position-relative" href="#" data-bs-toggle="offcanvas" data-bs-target="#notifPanel" aria-controls="notifPanel">
                        <i class="bi bi-bell fs-5"></i>
                        {% if unread_count and unread_count > 0 %}
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                {{ unread_count }}
                            </span>
                        {% endif %}
                    </a>
                </li>

                <!-- User Dropdown -->
                <li class="nav-item dropdown">
                    <a href="#" class="nav-link text-light d-flex align-items-center" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person-circle fs-5 me-2"></i>
                        Hi, 
                        {% if user_firstname %}
                            {{ user_firstname }}
                        {% else %}
                            {% if user_role_id == 1 %}
                                Farmer
                            {% elif user_role_id == 2 %}
                                Administrator
                            {% elif user_role_id == 3 %}
                                Agriculturist
                            {% else %}
                                User
                            {% endif %}
                        {% endif %}!
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="{% url 'base:account_info_panel' %}">
                            <i class="bi bi-person me-2"></i>My Account
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'base:transaction_history' %}">
                            <i class="bi bi-clock me-2"></i>My Transactions
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'base:farmland_owned' %}">
                            <i class="bi bi-geo-alt me-2"></i>My Farm Lands
                        </a></li>
                        {% if user_role_id == 3 or user_role_id == 2 %}
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{% url 'administrator:admin_dashboard' %}">
                                <i class="bi bi-shield-check me-2"></i>Admin Panel
                            </a></li>
                        {% endif %}
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <form action="{% url 'base:logout' %}" method="post" class="d-inline w-100">
                                {% csrf_token %}
                                <button type="submit" class="dropdown-item text-danger">
                                    <i class="bi bi-box-arrow-right me-2"></i>Log out
                                </button>
                            </form>
                        </li>
                    </ul>
                </li>
            </ul>
        </nav>
    </div>
        
        <!-- Main Navigation -->
    <nav class="ps-3 d-block bg-green-fc" aria-label="Site">
        <ul class="navbar-nav d-flex flex-row">
            <li class="nav-item dropdown me-3">
                <a href="{% url 'dashboard:forecast' %}" class="nav-link dropdown-toggle text-light" data-bs-toggle="dropdown" aria-expanded="false">
                    Forecast
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="{% url 'dashboard:forecast' %}">
                        <i class="bi bi-person me-2"></i>by Month
                    </a></li>
                    <li><a class="dropdown-item" href="{% url 'dashboard:forecast_bycommodity' %}">
                        <i class="bi bi-geo-alt me-2"></i>by Commodity
                    </a></li>
                </ul>
            </li>
            <li class="nav-item dropdown me-3">
                <a href="{% url 'dashboard:monitor' %}" class="nav-link text-light">
                    Monitor
                </a>
            </li>
            <li class="nav-item dropdown me-3">
                <a href="{% url 'base:newrecord' %}" class="nav-link dropdown-toggle text-light" data-bs-toggle="dropdown" aria-expanded="false">
                    Create Record
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="{% url 'base:plant_record' %}">
                        <i class="bi bi-plus-circle me-2"></i>New Plant Record
                    </a></li>
                    <li><a class="dropdown-item" href="{% url 'base:solo_harvest_record' %}">
                        <i class="bi bi-plus-circle me-2"></i>New Harvest Record
                    </a></li>
                    <li><a class="dropdown-item" href="{% url 'base:farmland_record' %}">
                        <i class="bi bi-plus-circle me-2"></i>New Farm Land Record
                    </a></li>
                </ul>
            </li>
        </ul>
    </nav>
</header>

<!-- Offcanvas Sidebar -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasguest" aria-labelledby="offcanvasExampleLabel">
    <div class="offcanvas-header bg-success text-white">
        <h5 class="offcanvas-title" id="offcanvasExampleLabel">
            <i class="bi bi-person-circle me-2"></i>Fruit Cast | {{user_firstname}}
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    
    <div class="offcanvas-header justify-content-center">      
        <img src="{% static 'images/logo/3.png' %}" alt="Fruit Cast Logo" style="max-height: 15vh;">
    </div>
    
    <div class="offcanvas-body d-flex flex-column h-100">  
        <!-- Quick Actions -->
        <div class="mb-4">
            <h6 class="text-muted text-uppercase small fw-bold mb-3">Quick Actions</h6>
            <div class="list-group list-group-flush">
                <a href="{% url 'base:plant_record' %}" class="list-group-item list-group-item-action border-0 rounded mb-2 bg-light">
                    <i class="bi bi-plus-circle me-2 text-success"></i>Create New Record
                </a>        
            </div>
        </div>

        <!-- Main Navigation -->
        <div class="mb-4">
            <h6 class="text-muted text-uppercase small fw-bold mb-3">Navigation</h6>
            <div class="list-group list-group-flush">
                <a href="{% url 'base:home' %}" class="list-group-item list-group-item-action border-0 py-2">
                    <i class="bi bi-house me-2"></i>Home
                </a>
                <a href="{% url 'dashboard:forecast' %}" class="list-group-item list-group-item-action border-0 py-2">
                    <i class="bi bi-graph-up me-2"></i>Forecast
                </a>
                <a href="{% url 'dashboard:monitor' %}" class="list-group-item list-group-item-action border-0 py-2">
                    <i class="bi bi-activity me-2"></i>Monitor
                </a>
                <a href="{% url 'base:newrecord' %}?view=transaction_history" class="list-group-item list-group-item-action border-0 py-2">
                    <i class="bi bi-clock-history me-2"></i>Record History
                </a>
                <a href="#" class="list-group-item list-group-item-action border-0 py-2">
                    <i class="bi bi-lightbulb me-2"></i>Fruit Plant Suggestion
                </a>
                <a href="{% url 'base:about' %}" class="list-group-item list-group-item-action border-0 py-2">
                    <i class="bi bi-info-circle me-2"></i>About Us
                </a>
                
                {% if user_role_id == 3 or user_role_id == 2 %}
                    <hr class="my-2">
                    <a href="{% url 'administrator:admin_dashboard' %}" class="list-group-item list-group-item-action border-0 py-2 text-warning">
                        <i class="bi bi-shield-check me-2"></i>Admin Panel
                    </a>
                {% endif %}
            </div>
        </div>

        <!-- Spacer -->
        <div class="flex-grow-1"></div>
        
        <!-- Footer -->
        <div class="text-center text-muted small">
            <hr>
            <p class="mb-0">Â© 2024 Fruit Cast</p>
        </div>
    </div>
</div>

<!-- Notifications Offcanvas -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="notifPanel" aria-labelledby="notifPanelLabel">
    <div class="offcanvas-header bg-green-fc text-white">
        <h5 class="offcanvas-title" id="notifPanelLabel">
            <i class="bi bi-bell me-2"></i>Notifications
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    
    <div class="offcanvas-body">
        {% if notifications %}
            <div class="list-group list-group-flush">
                {% for notification in notifications %}
                    <div class="list-group-item{% if not notification.is_read %} border-start border-primary border-3{% endif %} p-3" id="notif-{{ notification.id }}">
                        <a href="{{ notification.redirect_url }}" class="notif-link text-decoration-none" data-notif-id="{{ notification.id }}">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="bi bi-bell-fill text-success"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="text-dark{% if not notification.is_read %} fw-bold{% endif %}">
                                        {{ notification.message|truncatechars:150 }}
                                    </div>
                                    <small class="text-muted">
                                        <i class="bi bi-calendar3 me-1"></i>{{ notification.created_at|date:"M d, Y H:i" }}
                                    </small>
                                </div>
                            </div>
                        </a>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center text-muted py-5">
                <i class="bi bi-bell-slash display-1 text-muted"></i>
                <p class="mt-3">No notifications</p>
            </div>
        {% endif %}
        
        <div class="mt-3 text-center">
            <a href="{% url 'dashboard:notifications' %}" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-list me-1"></i>View all notifications
            </a>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle notification clicks
    document.querySelectorAll('.notif-link').forEach(function(link) {
        link.addEventListener('click', function(e) {
            var notifId = this.getAttribute('data-notif-id');
            // Mark as read via AJAX
            fetch("{% url 'dashboard:mark_notification_read' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: "notif_id=" + notifId
            }).then(response => {
                if (response.ok) {
                    // Update the notification styling
                    var notifItem = document.getElementById('notif-' + notifId);
                    if (notifItem) {
                        notifItem.classList.remove('border-start', 'border-primary', 'border-3');
                        var messageEl = notifItem.querySelector('.fw-bold');
                        if (messageEl) {
                            messageEl.classList.remove('fw-bold');
                        }
                    }
                }
            });
            // Let the link continue to its href
        });
    });

    // Add smooth animations for dropdowns
    document.querySelectorAll('.dropdown-toggle').forEach(function(toggle) {
        toggle.addEventListener('click', function(e) {
            // Bootstrap handles this automatically, but we can add custom animations if needed
        });
    });

    // Add active state to current page links
    var currentPath = window.location.pathname;
    document.querySelectorAll('.list-group-item-action[href]').forEach(function(link) {
        if (link.getAttribute('href') === currentPath) {
            link.classList.add('active');
        }
    });
});
</script>

<style>
/* Custom navbar styles */
#header {
    transition: all 0.3s ease;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

/* Notification badge pulse animation */
.nav-link .badge {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

/* Offcanvas improvements */
.offcanvas-body .list-group-item-action:hover {
    background-color: rgba(0,0,0,0.05);
    transform: translateX(5px);
    transition: all 0.2s ease;
}

/* Dropdown menu improvements */
.dropdown-menu {
    border: none;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    border-radius: 0.5rem;
}

.dropdown-item {
    transition: all 0.2s ease;
}

.dropdown-item:hover {
    background-color: rgba(0,123,255,0.1);
    transform: translateX(5px);
}

/* Notification styles */
.notif-link:hover {
    text-decoration: none !important;
}

.list-group-item.border-start {
    background-color: rgba(0,123,255,0.02);
}

/* Mobile responsiveness */
@media (max-width: 991.98px) {
    .d-none.d-lg-block {
        display: none !important;
    }
}

/* Logo hover effect */
.navbar-brand:hover img {
    transform: rotate(5deg) scale(1.05);
    transition: transform 0.3s ease;
}
</style>