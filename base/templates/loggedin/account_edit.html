{% block content %}
<div class="container p-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-success fw-bold mb-1">
                <i class="bi bi-person-gear me-2"></i>Edit Account Information
            </h2>
            <p class="text-muted mb-0">Update your personal details and contact information</p>
        </div>
    </div>

    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                <i class="bi bi-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-triangle{% else %}info-circle{% endif %} me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Form -->
    <form method="POST" novalidate id="account-edit-form">
        {% csrf_token %}
        
        <!-- Personal Information Section -->
        <div class="mb-4">
            <h5 class="text-success mb-3">
                <i class="bi bi-person-lines-fill me-2"></i>Personal Information
            </h5>
            <div class="row g-3">
                {% for field in form %}
                    {% if field.name in "firstname,lastname,middlename,nameextension,sex,birthdate,religion,civil_status" %}
                        <div class="{% if field.name == 'sex' %}col-12{% else %}col-md-6{% endif %}">
                            <label class="form-label" for="{{ field.id_for_label }}">
                                {% if field.name == "firstname" %}<i class="bi bi-person me-1"></i>{% endif %}
                                {% if field.name == "lastname" %}<i class="bi bi-person me-1"></i>{% endif %}
                                {% if field.name == "middlename" %}<i class="bi bi-person me-1"></i>{% endif %}
                                {% if field.name == "nameextension" %}<i class="bi bi-person-badge me-1"></i>{% endif %}
                                {% if field.name == "birthdate" %}<i class="bi bi-calendar me-1"></i>{% endif %}
                                {% if field.name == "religion" %}<i class="bi bi-church me-1"></i>{% endif %}
                                {% if field.name == "civil_status" %}<i class="bi bi-heart me-1"></i>{% endif %}
                                {{ field.label }}
                            </label>
                            {{ field }}
                            {% if field.errors %}
                                <div class="text-danger small mt-1">{{ field.errors }}</div>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Contact Information Section -->
        <div class="mb-4 pt-3 border-top">
            <h5 class="text-success mb-3">
                <i class="bi bi-telephone me-2"></i>Contact Information
            </h5>
            <div class="row g-3">
                {% for field in form %}
                    {% if field.name in "contact_number,user_email,emergency_contact_person,emergency_contact_number" %}
                        <div class="col-md-6">
                            <label class="form-label" for="{{ field.id_for_label }}">
                                {% if field.name == "contact_number" %}<i class="bi bi-phone me-1"></i>{% endif %}
                                {% if field.name == "user_email" %}<i class="bi bi-envelope me-1"></i>{% endif %}
                                {% if field.name == "emergency_contact_person" %}<i class="bi bi-person-exclamation me-1"></i>{% endif %}
                                {% if field.name == "emergency_contact_number" %}<i class="bi bi-telephone-plus me-1"></i>{% endif %}
                                {{ field.label }}
                            </label>
                            {{ field }}
                            {% if field.errors %}
                                <div class="text-danger small mt-1">{{ field.errors }}</div>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Address Information Section -->
        <div class="mb-4 pt-3 border-top">
            <h5 class="text-success mb-3">
                <i class="bi bi-geo-alt me-2"></i>Address Information
            </h5>
            <div class="row g-3">
                {% for field in form %}
                    {% if field.name in "address_details,municipality_id,barangay_id" %}
                        <div class="{% if field.name == 'address_details' %}col-12{% else %}col-md-6{% endif %}">
                            <label class="form-label" for="{{ field.id_for_label }}">
                                {% if field.name == "address_details" %}<i class="bi bi-house me-1"></i>{% endif %}
                                {% if field.name == "municipality_id" %}<i class="bi bi-geo-alt me-1"></i>{% endif %}
                                {% if field.name == "barangay_id" %}<i class="bi bi-map me-1"></i>{% endif %}
                                {{ field.label }}
                            </label>
                            {{ field }}
                            {% if field.errors %}
                                <div class="text-danger small mt-1">{{ field.errors }}</div>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %} 
            </div>
        </div>

        <!-- Additional Information Section -->
        <div class="mb-4 pt-3 border-top">
            <h5 class="text-success mb-3">
                <i class="bi bi-info-circle me-2"></i>Additional Information
            </h5>
            <div class="row g-3">
                {% for field in form %}
                    {% if field.name == "rsbsa_ref_number" %}
                        <div class="col-md-6">
                            <label class="form-label" for="{{ field.id_for_label }}">
                                <i class="bi bi-card-text me-1"></i>{{ field.label }}
                            </label>
                            {{ field }}
                            {% if field.errors %}
                                <div class="text-danger small mt-1">{{ field.errors }}</div>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mt-4 pt-3 border-top">
            <button type="submit" class="btn btn-success">
                <i class="bi bi-check-circle me-2"></i>Save Changes
            </button>
            
            <a href="{% url 'base:account_info_panel' %}" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle me-2"></i>Cancel
            </a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Enhanced Phone Number Formatting
    function formatPhoneNumber(input) {
        let value = input.value.replace(/\D/g, ''); // Remove all non-digits
        
        // Ensure it starts with +63
        if (!input.value.startsWith('+63')) {
            input.value = '+63';
            value = '';
        }
        
        // Remove the country code from value for formatting
        if (value.startsWith('63')) {
            value = value.substring(2);
        }
        
        // Format as +639XX XXX XXXX
        if (value.length >= 1 && value.charAt(0) === '9') {
            if (value.length <= 3) {
                input.value = '+63 9' + value.substring(1);
            } else if (value.length <= 6) {
                input.value = '+63 9' + value.substring(1, 3) + ' ' + value.substring(3);
            } else if (value.length <= 10) {
                input.value = '+63 9' + value.substring(1, 3) + ' ' + value.substring(3, 6) + ' ' + value.substring(6, 10);
            } else {
                // Limit to 10 digits after +63
                value = value.substring(0, 10);
                input.value = '+63 9' + value.substring(1, 3) + ' ' + value.substring(3, 6) + ' ' + value.substring(6, 10);
            }
        } else {
            // If doesn't start with 9, reset to +639
            input.value = '+63 9';
        }
    }

    function validatePhoneNumber(input) {
        const phoneRegex = /^\+63 9\d{2} \d{3} \d{4}$/;
        const isValid = phoneRegex.test(input.value);
        
        if (input.value.length > 4 && !isValid) {
            input.setCustomValidity('Phone number must be in the format: +63 9XX XXX XXXX');
        } else {
            input.setCustomValidity('');
        }
        
        return isValid;
    }

    // Apply phone formatting to all phone inputs
    const phoneInputs = document.querySelectorAll('.phone-input');
    phoneInputs.forEach(function(input) {
        // Set initial value if empty
        if (!input.value || input.value === '' || !input.value.startsWith('+63')) {
            if (input.value && !input.value.startsWith('+63')) {
                // Try to preserve existing number if it looks like a PH number
                let cleanNumber = input.value.replace(/\D/g, '');
                if (cleanNumber.startsWith('09')) {
                    cleanNumber = '63' + cleanNumber.substring(1);
                }
                if (cleanNumber.startsWith('63 9') && cleanNumber.length === 12) {
                    input.value = '+' + cleanNumber.substring(0, 3) + cleanNumber.substring(3, 5) + ' ' + 
                                  cleanNumber.substring(5, 8) + ' ' + cleanNumber.substring(8, 12);
                } else {
                    input.value = '+63 9';
                }
            } else {
                input.value = '+63';
            }
        }
        
        input.addEventListener('input', function(e) {
            const cursorPosition = e.target.selectionStart;
            formatPhoneNumber(e.target);
            
            // Prevent cursor from moving when typing
            if (cursorPosition <= 3) {
                e.target.setSelectionRange(4, 4); // Position after +63
            }
        });
        
        input.addEventListener('keydown', function(e) {
            // Prevent deletion of +63
            if (e.target.selectionStart < 4 && (e.key === 'Backspace' || e.key === 'Delete')) {
                e.preventDefault();
                e.target.setSelectionRange(4, 4);
            }
        });
        
        input.addEventListener('blur', function(e) {
            validatePhoneNumber(e.target);
        });
        
        input.addEventListener('focus', function(e) {
            if (e.target.value === '+63') {
                e.target.setSelectionRange(4, 4);
            }
        });
    });

    // Name validation for character restrictions
    function validateNameInput(input) {
        const nameRegex = /^[a-zA-ZÀ-ÿ\u0100-\u017F\u1E00-\u1EFF'\-\s\.]*$/;
        const value = input.value;
        
        if (!nameRegex.test(value)) {
            // Remove invalid characters
            input.value = value.replace(/[^a-zA-ZÀ-ÿ\u0100-\u017F\u1E00-\u1EFF'\-\s\.]/g, '');
        }
    }

    // Religion field validation (character restrictions + 50 character limit)
    function validateReligionInput(input) {
        const religionRegex = /^[a-zA-ZÀ-ÿ\u0100-\u017F\u1E00-\u1EFF'\-\s\.]*$/;
        let value = input.value;
        
        // Remove invalid characters
        if (!religionRegex.test(value)) {
            value = value.replace(/[^a-zA-ZÀ-ÿ\u0100-\u017F\u1E00-\u1EFF'\-\s\.]/g, '');
        }
        
        // Limit to 50 characters
        if (value.length > 50) {
            value = value.substring(0, 50);
        }
        
        input.value = value;
    }

    // Address details validation (150 character limit)
    function validateAddressInput(input) {
        const maxLength = 150;
        if (input.value.length > maxLength) {
            input.value = input.value.substring(0, maxLength);
        }
    }

    // Apply name validation to name fields
    const nameFields = ['id_firstname', 'id_lastname', 'id_middlename', 'id_nameextension', 'id_emergency_contact_person'];
    nameFields.forEach(function(fieldId) {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', function(e) {
                validateNameInput(e.target);
            });
        }
    });

    // Apply religion validation
    const religionField = document.getElementById('id_religion');
    if (religionField) {
        religionField.addEventListener('input', function(e) {
            validateReligionInput(e.target);
        });
    }

    // Apply address validation
    const addressField = document.getElementById('id_address_details');
    if (addressField) {
        addressField.addEventListener('input', function(e) {
            validateAddressInput(e.target);
        });
    }

    // Birthdate year validation (limit to 4 digits)
    const birthdateInput = document.getElementById('id_birthdate');
    if (birthdateInput) {
        birthdateInput.addEventListener('input', function() {
            const value = this.value;
            if (value) {
                const dateParts = value.split('-');
                // Limit year to 4 digits
                if (dateParts[0] && dateParts[0].length > 4) {
                    dateParts[0] = dateParts[0].substring(0, 4);
                    this.value = dateParts.join('-');
                }
            }
        });
    }

    // Form validation and confirmation
    const form = document.getElementById("account-edit-form");
    if (form) {
        form.addEventListener("submit", function (e) {
            // Validate phone numbers before submission
            const phoneFields = ['id_contact_number', 'id_emergency_contact_number'];
            let phoneValid = true;
            
            phoneFields.forEach(fieldId => {
                const phoneInput = document.getElementById(fieldId);
                if (phoneInput && !validatePhoneNumber(phoneInput)) {
                    phoneValid = false;
                    phoneInput.focus();
                    alert('Please enter a valid phone number in the format: +63 9XX XXX XXXX');
                }
            });
            
            if (!phoneValid) {
                e.preventDefault();
                return false;
            }
            
            const message = "Are you sure you want to save these changes to your account information?\nSiguro ka bang gusto mong i-save ang mga pagbabago?";
            if (!confirm(message)) {
                e.preventDefault();
            }
        });
    }

    // Municipality and barangay dynamic selection
    const municipalitySelect = document.getElementById('id_municipality_id');
    const barangaySelect = document.getElementById('id_barangay_id');

    if (municipalitySelect && barangaySelect) {
        municipalitySelect.addEventListener('change', function() {
            const municipalityId = this.value;
            barangaySelect.innerHTML = '<option value="">Loading...</option>';
            barangaySelect.disabled = true;

            if (municipalityId) {
                fetch(`/get-barangays/${municipalityId}/`)
                    .then(response => response.json())
                    .then(data => {
                        barangaySelect.innerHTML = '';
                        if (data.length > 0) {
                            barangaySelect.disabled = false;
                            barangaySelect.innerHTML = '<option value="">Select Barangay</option>';
                            data.forEach(barangay => {
                                const option = document.createElement('option');
                                option.value = barangay.id;
                                option.textContent = barangay.barangay;
                                barangaySelect.appendChild(option);
                            });
                        } else {
                            barangaySelect.innerHTML = '<option value="">No Barangays available</option>';
                            barangaySelect.disabled = true;
                        }
                    })
                    .catch(error => {
                        console.error('Error loading barangays:', error);
                        barangaySelect.innerHTML = '<option value="">Error loading barangays</option>';
                        barangaySelect.disabled = true;
                    });
            } else {
                barangaySelect.innerHTML = '<option value="">Select a municipality first</option>';
                barangaySelect.disabled = true;
            }
        });
    }
});
</script>

<style>
.phone-input:focus {
    border-color: #198754;
    box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
}

.phone-input:invalid {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

/* Character limit indicators */
.form-control[maxlength] {
    position: relative;
}

.char-limit-info {
    font-size: 0.75rem;
    color: #6c757d;
    text-align: right;
    margin-top: 0.25rem;
}

.char-limit-warning {
    color: #ffc107;
}

.char-limit-danger {
    color: #dc3545;
}
</style>

{% endblock content %}

