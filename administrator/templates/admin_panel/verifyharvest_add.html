{% extends "admin_login/layout.html" %}

{% block title %}
Fruit Cast | Add Verified Harvest Record
{% endblock title %}

{% block content %}
<div class="main-user">
    <div class="monitor-user-content justify-content-center">
        <div class="card shadow-sm rounded-4 p-4 mb-3" style="max-width: 900px; margin: 0 auto;">
            <h1 class="mb-4 text-success fw-bold text-center">
                <i class="bi bi-plus-circle"></i>
                Add Verified Harvest Record
            </h1>
 
            <!-- Messages -->
            {% if messages %}
                {% for message in messages %}
                <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
                    <i class="bi bi-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-triangle{% elif message.tags == 'warning' %}exclamation-triangle-fill{% else %}info-circle{% endif %} me-2"></i>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            {% endif %}

            <!-- Form Section -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-clipboard-data me-2"></i>Harvest Record Information
                    </h5>
                </div>
                <div class="card-body bg-light">
                    <form method="post">
                        {% csrf_token %}
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="id_harvest_date" class="form-label">
                                    <i class="bi bi-calendar-date me-1"></i>Harvest Date *
                                </label>
                                {{ form.harvest_date }}
                            </div>
                            <div class="col-md-4">
                                <label for="id_commodity_id" class="form-label">
                                    <i class="bi bi-basket me-1"></i>Commodity *
                                </label>
                                {{ form.commodity_id }}
                            </div>
                            <div class="col-md-4">
                                <label for="id_total_weight_kg" class="form-label">
                                    <i class="bi bi-weight me-1"></i>Total Weight (kg) *
                                </label>
                                {{ form.total_weight_kg }}
                            </div>
                            <div class="col-md-4">
                                <label for="id_municipality" class="form-label">
                                    <i class="bi bi-geo-alt me-1"></i>Municipality * 
                                </label>
                                <select id="id_municipality" name="municipality" class="form-select">
                                    <option value="">Select Municipality</option>
                                    {% for m in municipalities %}
                                        <option value="{{ m.pk }}">{{ m.municipality }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="id_barangay" class="form-label">
                                    <i class="bi bi-map me-1"></i>Barangay 
                                    <small class="text-muted">(Optional)</small>
                                </label>
                                <select id="id_barangay" name="barangay" class="form-select">
                                    <option value="">No Barangay Selected</option>
                                    <!-- Barangays will be dynamically loaded -->
                                </select>
                            </div>
                            <div class="col-12">
                                <label for="id_remarks" class="form-label">
                                    <i class="bi bi-chat-text me-1"></i>Remarks
                                    <small class="text-muted">(Optional)</small>
                                </label>
                                {{ form.remarks }}
                            </div>
                        </div>

                        <div class="d-flex gap-2 mt-4">
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check-lg me-2"></i>Save Record
                            </button>
                            <a href="{% url 'administrator:admin_verifyharvestrec' %}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left me-2"></i>Back to List
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- CSV Upload Section -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-upload me-2"></i>Bulk Upload
                    </h5>
                </div>
                <div class="card-body bg-light">
                    <p class="mb-3">Or upload a CSV file of harvest records:</p>
                    
                    <div class="alert alert-warning">
                        <h6 class="alert-heading">
                            <i class="bi bi-file-earmark-spreadsheet me-2"></i>CSV Format Required:
                        </h6>
                        <p class="mb-2"><strong>Header:</strong></p>
                        {% if is_overall_admin %}
                        <code>harvest_date,commodity,municipality,barangay,total_weight_kg,remarks</code>
                        <p class="mb-2 mt-2"><strong>Example:</strong></p>
                        <code>2025-08-01,Mango,Balanga City,San Jose,100,Good harvest</code>
                        {% else %}
                        <code>harvest_date,commodity,barangay,total_weight_kg,remarks</code>
                        <p class="mb-2 mt-2"><strong>Example:</strong></p>
                        <code>2025-08-01,Mango,San Jose,100,Good harvest</code>
                        {% endif %}
                        
                        <div class="mt-3">
                            <h6><i class="bi bi-info-circle me-1"></i>Important Notes:</h6>
                            <ul class="mb-0 small">
                                <li>Date format: YYYY-MM-DD or DD/MM/YYYY</li>
                                <li>Commodity names must match existing commodities in the system</li>
                                {% if is_overall_admin %}
                                <li>Municipality names must be exact matches (Note: "Balanga" will be automatically converted to "Balanga City")</li>
                                {% else %}
                                <li>Records will be automatically assigned to your municipality</li>
                                {% endif %}
                                <li>Barangay names must be exact matches (optional)</li>
                                <li>Weight values should be numeric (use decimal point, not comma)</li>
                                <li>All fields except remarks and barangay are required</li>
                                <li><strong>File size limit:</strong> Maximum 50MB per upload</li>
                                <li><strong>Row limit:</strong> Maximum 10,000 records per upload</li>
                                <li><strong>Large files:</strong> For files with 1,000+ records, upload may take several minutes</li>
                                <li><strong>File encoding:</strong> Save your CSV file as UTF-8 encoding to avoid character issues</li>
                                <li><strong>Special characters:</strong> Characters like ñ, á, é, etc. are supported</li>
                            </ul>
                        </div>
                    </div>

                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="row g-3 align-items-end">
                            <div class="col-md-6">
                                <label for="csv_file" class="form-label">
                                    <i class="bi bi-file-earmark-arrow-up me-1"></i>Choose CSV File
                                </label>
                                <input type="file" name="csv_file" id="csv_file" class="form-control" accept=".csv" required>
                                <div class="form-text">
                                    <i class="bi bi-info-circle me-1"></i>Max file size: 10MB. If you encounter encoding errors, ensure your CSV is saved as UTF-8.
                                </div>
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-info w-100" id="uploadBtn">
                                    <i class="bi bi-upload me-2"></i>Upload CSV
                                    <span class="spinner-border spinner-border-sm ms-2 d-none" id="uploadSpinner"></span>
                                </button>
                            </div>
                            <div class="col-md-3">
                                <a href="#" class="btn btn-outline-secondary w-100" onclick="downloadTemplate()">
                                    <i class="bi bi-download me-2"></i>Download Template
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Help Section -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="bi bi-question-circle me-2"></i>Need Help?
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <h6 class="text-primary">
                                <i class="bi bi-clipboard-check me-1"></i>Form Validation
                            </h6>
                            <ul class="list-unstyled small text-muted">
                                <li><i class="bi bi-check text-success me-1"></i>All fields except remarks and barangay are required</li>
                                <li><i class="bi bi-check text-success me-1"></i>Harvest date cannot be in the future</li>
                                <li><i class="bi bi-check text-success me-1"></i>Weight values must be positive numbers</li>
                                {% if not is_overall_admin %}
                                <li><i class="bi bi-check text-success me-1"></i>Municipality is automatically assigned to your assigned municipality</li>
                                {% else %}
                                <li><i class="bi bi-check text-success me-1"></i>Municipality selection will auto-populate barangays</li>
                                {% endif %}
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary">
                                <i class="bi bi-lightbulb me-1"></i>Quick Tips
                            </h6>
                            <ul class="list-unstyled small text-muted">
                                <li><i class="bi bi-arrow-right text-info me-1"></i>Use the CSV upload for bulk data entry</li>
                                <li><i class="bi bi-arrow-right text-info me-1"></i>Download the template for the correct format</li>
                                <li><i class="bi bi-arrow-right text-info me-1"></i>Double-check weight calculations before saving</li>
                                {% if is_overall_admin %}
                                <li><i class="bi bi-arrow-right text-info me-1"></i>You can upload data for all municipalities</li>
                                {% else %}
                                <li><i class="bi bi-arrow-right text-info me-1"></i>Data will be assigned to your municipality automatically</li>
                                {% endif %}
                                <li><i class="bi bi-arrow-right text-info me-1"></i>Special characters (ñ, á, é) are supported</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // File input validation
        const fileInput = document.getElementById('csv_file');
        if (fileInput) {
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Check file type
                    if (!file.name.toLowerCase().endsWith('.csv')) {
                        alert('Please select a valid CSV file.');
                        e.target.value = '';
                        return;
                    }
                    
                    // Check file size (10MB limit)
                    const maxSize = 10 * 1024 * 1024; // 10MB in bytes
                    if (file.size > maxSize) {
                        alert('File size must be less than 10MB.');
                        e.target.value = '';
                        return;
                    }
                }
            });
        }

        // Form validation
        const mainForm = document.querySelector('form[method="post"]:not([enctype])');
        if (mainForm) {
            mainForm.addEventListener('submit', function(e) {
                const harvestDate = document.getElementById('id_harvest_date');
                const municipality = document.getElementById('id_municipality');
                const barangay = document.getElementById('id_barangay');
                
                // Check if harvest date is not in the future
                if (harvestDate && harvestDate.value) {
                    const selectedDate = new Date(harvestDate.value);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    if (selectedDate > today) {
                        e.preventDefault();
                        alert('Harvest date cannot be in the future.');
                        harvestDate.focus();
                        return false;
                    }
                }
                
                // No need to validate barangay since it's optional
            });
        }

        // CSV upload form handling
        const csvForm = document.querySelector('form[enctype="multipart/form-data"]');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadSpinner = document.getElementById('uploadSpinner');
        const fileInput = document.getElementById('csv_file');

        if (csvForm) {
            csvForm.addEventListener('submit', function(e) {
                const file = fileInput.files[0];
                if (!file) {
                    e.preventDefault();
                    alert('Please select a CSV file to upload.');
                    return false;
                }
                
                // Show loading state
                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<i class="bi bi-upload me-2"></i>Uploading... <span class="spinner-border spinner-border-sm ms-2"></span>';
                
                // Show warning for large files
                if (file.size > 1024 * 1024) { // > 1MB
                    const fileSizeMB = (file.size / (1024 * 1024)).toFixed(1);
                    if (!confirm(`You are uploading a ${fileSizeMB}MB file. This may take several minutes to process. Do you want to continue?`)) {
                        e.preventDefault();
                        // Reset button state
                        uploadBtn.disabled = false;
                        uploadBtn.innerHTML = '<i class="bi bi-upload me-2"></i>Upload CSV';
                        return false;
                    }
                }
                
                // Estimate processing time based on file size
                const estimatedSeconds = Math.max(30, Math.min(300, file.size / (1024 * 100))); // 30s to 5min
                setTimeout(() => {
                    if (uploadBtn.disabled) {
                        uploadBtn.innerHTML = '<i class="bi bi-upload me-2"></i>Still processing... <span class="spinner-border spinner-border-sm ms-2"></span>';
                    }
                }, estimatedSeconds * 1000);
            });
        }
    });

    // Dynamic Barangay Dropdown
    document.getElementById('id_municipality').addEventListener('change', function() {
        var municipalityId = this.value;
        var barangaySelect = document.getElementById('id_barangay');
        
        // Reset and disable barangay dropdown
        barangaySelect.innerHTML = '<option value="">Loading...</option>';
        barangaySelect.disabled = true;
        
        if (municipalityId) {
            fetch('/administrator/get_barangays/' + municipalityId + '/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    barangaySelect.innerHTML = '<option value="">No Barangay Selected</option>';
                    data.forEach(function(barangay) {
                        barangaySelect.innerHTML += '<option value="' + barangay.id + '">' + barangay.barangay + '</option>';
                    });
                    barangaySelect.disabled = false;
                })
                .catch(error => {
                    console.error('Error fetching barangays:', error);
                    barangaySelect.innerHTML = '<option value="">No Barangay Selected</option>';
                    barangaySelect.disabled = false;
                });
        } else {
            barangaySelect.innerHTML = '<option value="">No Barangay Selected</option>';
            barangaySelect.disabled = false;
        }
    });

    function downloadTemplate() {
        // Create a sample CSV content based on admin type
        {% if is_overall_admin %}
        const csvContent = "harvest_date,commodity,municipality,barangay,total_weight_kg,remarks\n" +
                          "2024-08-01,Mango,Balanga City,San Jose,100.00,Good harvest\n" +
                          "2024-08-15,Banana,Dinalupihan,Layac,75.50,Excellent quality\n" +
                          "15/08/2024,Rambutan,Hermosa,Burgos,50.25,High quality fruit";
        {% else %}
        const csvContent = "harvest_date,commodity,barangay,total_weight_kg,remarks\n" +
                          "2024-08-01,Mango,San Jose,100.00,Good harvest\n" +
                          "2024-08-15,Banana,Layac,75.50,Excellent quality\n" +
                          "15/08/2024,Rambutan,Burgos,50.25,High quality fruit";
        {% endif %}
        
        // Create and download the file
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        {% if is_overall_admin %}
        a.download = 'harvest_records_template_overall.csv';
        {% else %}
        a.download = 'harvest_records_template_municipal.csv';
        {% endif %}
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }
</script>
{% endblock content %}