{% extends "admin_login/layout.html" %}

{% block title %}
Fruit Cast | Add Verified Harvest Record
{% endblock title %}

{% block content %}
<div class="main-user">
    <div class="monitor-user-content justify-content-center">
        <div class="card shadow-sm rounded-4 p-4 mb-3" style="max-width: 900px; margin: 0 auto;">
            <h1 class="mb-4 text-success fw-bold text-center">
                <i class="bi bi-plus-circle"></i>
                Add Verified Harvest Record
            </h1>

            <!-- Form Section -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-clipboard-data me-2"></i>Harvest Record Information
                    </h5>
                </div>
                <div class="card-body bg-light">
                    <form method="post">
                        {% csrf_token %}
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="id_harvest_date" class="form-label">
                                    <i class="bi bi-calendar-date me-1"></i>Harvest Date *
                                </label>
                                {{ form.harvest_date }}
                            </div>
                            <div class="col-md-4">
                                <label for="id_commodity_id" class="form-label">
                                    <i class="bi bi-basket me-1"></i>Commodity *
                                </label>
                                {{ form.commodity_id }}
                            </div>
                            <div class="col-md-4">
                                <label for="id_total_weight_kg" class="form-label">
                                    <i class="bi bi-weight me-1"></i>Total Weight (kg) *
                                </label>
                                {{ form.total_weight_kg }}
                            </div>
                            <div class="col-md-4">
                                <label for="id_weight_per_unit_kg" class="form-label">
                                    <i class="bi bi-speedometer2 me-1"></i>Weight per Unit (kg)
                                </label>
                                {{ form.weight_per_unit_kg }}
                            </div>
                            <div class="col-md-4">
                                <label for="id_municipality" class="form-label">
                                    <i class="bi bi-geo-alt me-1"></i>Municipality * 
                                </label>
                                <select id="id_municipality" name="municipality" class="form-select">
                                    <option value="">Select Municipality</option>
                                    {% for m in municipalities %}
                                        <option value="{{ m.pk }}">{{ m.municipality }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="id_barangay" class="form-label">
                                    <i class="bi bi-map me-1"></i>Barangay 
                                    <small class="text-muted">(Optional)</small>
                                </label>
                                <select id="id_barangay" name="barangay" class="form-select">
                                    <option value="">No Barangay Selected</option>
                                    <!-- Barangays will be dynamically loaded -->
                                </select>
                            </div>
                            <div class="col-12">
                                <label for="id_remarks" class="form-label">
                                    <i class="bi bi-chat-text me-1"></i>Remarks
                                    <small class="text-muted">(Optional)</small>
                                </label>
                                {{ form.remarks }}
                            </div>
                        </div>

                        <div class="d-flex gap-2 mt-4">
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check-lg me-2"></i>Save Record
                            </button>
                            <a href="{% url 'administrator:admin_verifyharvestrec' %}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left me-2"></i>Back to List
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- CSV Upload Section -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-upload me-2"></i>Bulk Upload
                    </h5>
                </div>
                <div class="card-body bg-light">
                    <p class="mb-3">Or upload a CSV file of harvest records:</p>
                    
                    <div class="alert alert-warning">
                        <h6 class="alert-heading">
                            <i class="bi bi-file-earmark-spreadsheet me-2"></i>CSV Format Required:
                        </h6>
                        <p class="mb-2"><strong>Header:</strong></p>
                        <code>harvest_date,commodity,municipality,barangay,total_weight_kg,weight_per_unit_kg,remarks</code>
                        <p class="mb-2 mt-2"><strong>Example:</strong></p>
                        <code>2025-08-01,Mango,Balanga,San Jose,100,1.2,Good harvest</code>
                        
                        <div class="mt-3">
                            <h6><i class="bi bi-info-circle me-1"></i>Important Notes:</h6>
                            <ul class="mb-0 small">
                                <li>Date format: YYYY-MM-DD</li>
                                <li>Commodity names must match existing commodities in the system</li>
                                <li>Municipality and barangay names must be exact matches</li>
                                <li>Weight values should be numeric (use decimal point, not comma)</li>
                                <li>Remarks field is optional</li>
                            </ul>
                        </div>
                    </div>

                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="row g-3 align-items-end">
                            <div class="col-md-6">
                                <label for="csv_file" class="form-label">
                                    <i class="bi bi-file-earmark-arrow-up me-1"></i>Choose CSV File
                                </label>
                                <input type="file" name="csv_file" id="csv_file" class="form-control" accept=".csv" required>
                                <div class="form-text">
                                    <i class="bi bi-info-circle me-1"></i>Maximum file size: 10MB
                                </div>
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-info w-100">
                                    <i class="bi bi-upload me-2"></i>Upload CSV
                                </button>
                            </div>
                            <div class="col-md-3">
                                <a href="#" class="btn btn-outline-secondary w-100" onclick="downloadTemplate()">
                                    <i class="bi bi-download me-2"></i>Download Template
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Help Section -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="bi bi-question-circle me-2"></i>Need Help?
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <h6 class="text-primary">
                                <i class="bi bi-clipboard-check me-1"></i>Form Validation
                            </h6>
                            <ul class="list-unstyled small text-muted">
                                <li><i class="bi bi-check text-success me-1"></i>All fields except remarks are required</li>
                                <li><i class="bi bi-check text-success me-1"></i>Harvest date cannot be in the future</li>
                                <li><i class="bi bi-check text-success me-1"></i>Weight values must be positive numbers</li>
                                <li><i class="bi bi-check text-success me-1"></i>Municipality selection will auto-populate barangays</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary">
                                <i class="bi bi-lightbulb me-1"></i>Quick Tips
                            </h6>
                            <ul class="list-unstyled small text-muted">
                                <li><i class="bi bi-arrow-right text-info me-1"></i>Use the CSV upload for bulk data entry</li>
                                <li><i class="bi bi-arrow-right text-info me-1"></i>Download the template for the correct format</li>
                                <li><i class="bi bi-arrow-right text-info me-1"></i>Double-check weight calculations before saving</li>
                                <li><i class="bi bi-arrow-right text-info me-1"></i>Add meaningful remarks for better tracking</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages -->
            {% if messages %}
                {% for message in messages %}
                <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show mt-3" role="alert">
                    <i class="bi bi-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-triangle{% else %}info-circle{% endif %} me-2"></i>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            {% endif %}

        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // File input validation
        const fileInput = document.getElementById('csv_file');
        if (fileInput) {
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Check file type
                    if (!file.name.toLowerCase().endsWith('.csv')) {
                        alert('Please select a valid CSV file.');
                        e.target.value = '';
                        return;
                    }
                    
                    // Check file size (10MB limit)
                    const maxSize = 10 * 1024 * 1024; // 10MB in bytes
                    if (file.size > maxSize) {
                        alert('File size must be less than 10MB.');
                        e.target.value = '';
                        return;
                    }
                }
            });
        }

        // Form validation
        const mainForm = document.querySelector('form[method="post"]:not([enctype])');
        if (mainForm) {
            mainForm.addEventListener('submit', function(e) {
                const harvestDate = document.getElementById('id_harvest_date');
                const municipality = document.getElementById('id_municipality');
                const barangay = document.getElementById('id_barangay');
                
                // Check if harvest date is not in the future
                if (harvestDate && harvestDate.value) {
                    const selectedDate = new Date(harvestDate.value);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    if (selectedDate > today) {
                        e.preventDefault();
                        alert('Harvest date cannot be in the future.');
                        harvestDate.focus();
                        return false;
                    }
                }
                
                // No need to validate barangay since it's optional
            });
        }
    });

    // Dynamic Barangay Dropdown
    document.getElementById('id_municipality').addEventListener('change', function() {
        var municipalityId = this.value;
        var barangaySelect = document.getElementById('id_barangay');
        
        // Reset and disable barangay dropdown
        barangaySelect.innerHTML = '<option value="">Loading...</option>';
        barangaySelect.disabled = true;
        
        if (municipalityId) {
            fetch('/get_barangays/' + municipalityId + '/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    barangaySelect.innerHTML = '<option value="">No Barangay Selected</option>';
                    data.forEach(function(barangay) {
                        barangaySelect.innerHTML += '<option value="' + barangay.id + '">' + barangay.barangay + '</option>';
                    });
                    barangaySelect.disabled = false;
                })
                .catch(error => {
                    console.error('Error fetching barangays:', error);
                    barangaySelect.innerHTML = '<option value="">No Barangay Selected</option>';
                    barangaySelect.disabled = false;
                });
        } else {
            barangaySelect.innerHTML = '<option value="">No Barangay Selected</option>';
            barangaySelect.disabled = false;
        }
    });

    function downloadTemplate() {
        // Create a sample CSV content
        const csvContent = "harvest_date,commodity,municipality,barangay,total_weight_kg,weight_per_unit_kg,remarks\n" +
                          "2024-08-01,Mango,Balanga,San Jose,100.00,1.20,Good harvest\n" +
                          "2024-08-15,Banana,Dinalupihan,Layac,75.50,0.80,Excellent quality";
        
        // Create and download the file
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = 'harvest_records_template.csv';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }
</script>
{% endblock content %}