{% extends "forecasting/layout.html" %}
{% load static %}
{% load dashboard_extras %}

{% block title %}
Forecast by Commodity
{% endblock %}
 
{% block content %}

    <div class="main-user row">
        <div class="main-user-content justify-content-center col-lg-9 col-md-12 float-left">
            <div id="top-section" class="card shadow-sm rounded-4 p-4 mb-4 text-center" style="background: #fffefc;">
                <!-- Header Section -->
                <div id="header-section" class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="text-success fw-bold mb-0">
                        <i class="bi bi-bar-chart me-2"></i>Forecasted Amount by Commodity
                    </h1>
                </div>

                <!-- Mobile Navigation -->
                <div id="mobilenav-section" class="card d-md-none rounded-4 shadow-sm mb-3">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-list-nested me-2"></i>Navigate
                        </h5>
                        <button class="btn btn-outline-light btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarCollapse" aria-expanded="false" aria-controls="sidebarCollapse">
                            <span class="d-none d-sm-inline">Show Sections</span> <i class="bi bi-chevron-down ms-1"></i>
                        </button>
                    </div>
                    <div class="collapse d-md-block" id="sidebarCollapse">
                        <div class="card-body p-2">
                            <a href="#chart-section" class="btn btn-outline-success w-100 mb-2">Forecast Chart</a>
                            <a href="#table-section" class="btn btn-outline-success w-100 mb-2">Summary Table</a>
                            <a href="#export-section" class="btn btn-outline-success w-100">Export Options</a>
                            <a href="{% url 'dashboard:forecast' %}" class="btn btn-secondary w-100">
                                <i class="bi bi-graph-up me-2"></i>To Monthly Forecast
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Filters Card -->
                <div id="filter-card" class="card shadow-sm mb-4 border-0">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-funnel me-2"></i>Filters</h5>
                    </div>
                    <div class="card-body bg-light">
                        <form method="get" id="summary-forecast-form">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label for="filter_month" class="form-label fw-medium">
                                        <i class="bi bi-calendar me-1 text-success"></i>Month
                                    </label>
                                    <select class="form-select" name="filter_month" id="filter_month">
                                        {% for m in months %}
                                            <option value="{{ m.number }}" {% if m.number|stringformat:"s" == filter_month|stringformat:"s" %}selected{% endif %}>
                                                {{ m.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="filter_year" class="form-label fw-medium">
                                        <i class="bi bi-calendar-event me-1 text-success"></i>Year
                                    </label>
                                    <select class="form-select" name="filter_year" id="filter_year">
                                        {% for y in available_years %}
                                            <option value="{{ y }}" {% if y|stringformat:"s" == filter_year|stringformat:"s" %}selected{% endif %}>{{ y }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="municipality" class="form-label fw-medium">
                                        <i class="bi bi-geo-alt me-1 text-success"></i>Municipality
                                    </label>
                                    <select class="form-select" name="municipality_id" id="municipality">
                                        <option value="14" {% if selected_municipality|stringformat:"s" == "14" %}selected{% endif %}>Overall</option>
                                        {% for muni in all_municipalities %}
                                            <option value="{{ muni.municipality_id }}" {% if muni.municipality_id|stringformat:"s" == selected_municipality|stringformat:"s" %}selected{% endif %}>
                                                {{ muni.municipality }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12 d-flex justify-content-center">
                                    <button type="submit" class="btn btn-success px-4">
                                        <i class="bi bi-search me-1"></i>Apply Filter
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                {% if forecast_summary_chart %}
                    <!-- Chart Card -->
                    <div id="chart-section" class="card shadow-sm mb-4 border-0">
                        <div class="card-header" style="background: linear-gradient(135deg, #198754 0%, #146c43 100%);">
                            <h5 class="mb-0 text-white">
                                <i class="bi bi-bar-chart me-2"></i>Commodity Forecast Analysis (Top 10)
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="forecastSummaryBarChart"></canvas>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <!-- No Data State -->
                    <div class="card shadow-sm mb-4 border-0">
                        <div class="card-body text-center py-5">
                            <div class="text-muted mb-4">
                                <i class="bi bi-bar-chart" style="font-size: 4rem; opacity: 0.6;"></i>
                            </div>
                            <h4 class="text-muted mb-3">No Forecast Data Available</h4>
                            <p class="text-muted mb-4">No forecast data available for this commodity and municipality. Please contact your administrator.</p>
                            <div class="alert alert-warning d-inline-block">
                                <i class="bi bi-success-circle me-2"></i>
                                Contact your administrator if you believe data should be available.
                            </div>
                        </div>
                    </div>
                {% endif %}

                {% if forecast_summary %}
                    <!-- Data Table Card -->
                    <div id="table-section" class="card shadow-sm mb-4 border-0">
                        <div class="card-header bg-light d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                            <h5 class="mb-2 mb-md-0 text-success">
                                <i class="bi bi-table me-2"></i>Commodity Summary Data
                            </h5>
                            <div class="d-flex gap-2 flex-wrap">
                                <form method="get" action="{% url 'dashboard:forecast_csv' %}">
                                    <input type="hidden" name="csv_type" value="by_commodity">
                                    <input type="hidden" name="filter_month" value="{{ filter_month }}">
                                    <input type="hidden" name="filter_year" value="{{ filter_year }}">
                                    <input type="hidden" name="municipality_id" value="{{ selected_municipality }}">
                                    <button type="submit" class="btn btn-outline-success btn-sm">
                                        <i class="bi bi-file-earmark-excel me-1"></i>CSV
                                    </button>
                                </form>
                                <button type="button" class="btn btn-outline-warning btn-sm" onclick="downloadCombinedCommodityPDF()">
                                    <i class="bi bi-file-pdf me-1"></i>PDF
                                </button>

                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover mb-0">
                                    <thead class="table-success">
                                        <tr>
                                            <th class="py-3"><i class="bi bi-box-seam me-1"></i>Commodity</th>
                                            <th class="py-3"><i class="bi bi-graph-up me-1"></i>Forecasted Amount (kg)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in forecast_summary %}
                                        <tr>
                                            <td class="fw-medium py-1">{{ row.commodity }}</td>
                                            <td class="py-1">
                                                <span class="badge bg-success-subtle text-success fs-6">
                                                    {{ row.forecasted_kg|format_number }} kg
                                                </span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                {% endif %}
            </div>
        </div>

        <div id="desktopnav-section" class="d-none d-lg-block col-lg-3 float-right main-user-content" style="background: #f7fff2;">
            <div style="top: 1rem;">
                <!-- Navigation Card -->
                <div class="card shadow-sm mb-4 border-0">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0 text-center">
                            <i class="bi bi-compass me-2"></i>Quick Navigation
                        </h6>
                    </div>
                    <div class="card-body bg-light">
                        <div class="d-grid gap-2">
                            <a href="#chart-section" class="btn btn-outline-success">
                                <i class="bi bi-graph-up me-2"></i>
                                <span>Forecast Chart</span>
                            </a>
                            <a href="#table-section" class="btn btn-outline-success">
                                <i class="bi bi-table text-success me-3"></i>
                                <span>Data Table</span>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Back Navigation Card -->
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-arrow-left me-2"></i>Navigation
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid">
                            <a href="{% url 'dashboard:forecast' %}" class="btn btn-outline-success">
                                <i class="bi bi-graph-up me-2"></i>To Monthly Forecast
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% if forecast_summary_chart %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var barLabels = {{ forecast_summary_chart.labels|safe }};
        var barValues = {{ forecast_summary_chart.values|safe }};
        
        console.log('Chart data loaded with commodities sorted by descending forecast values');
        
        var ctxBar = document.getElementById('forecastSummaryBarChart');
        if (ctxBar) {
            new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: barLabels,
                    datasets: [{
                        label: 'Forecasted Amount (kg)',
                        data: barValues,
                        backgroundColor: 'rgba(25, 135, 84, 0.8)',
                        borderColor: 'rgba(25, 135, 84, 1)',
                        borderWidth: 1,
                        borderRadius: 4,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 20,
                            bottom: 10
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(25, 135, 84, 1)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    return 'Forecast: ' + context.parsed.y.toLocaleString() + ' kg';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#6c757d',
                                font: {
                                    size: 12
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: '#6c757d',
                                font: {
                                    size: 12
                                },
                                callback: function(value) {
                                    return value.toLocaleString() + ' kg';
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }
    });
</script>
{% endif %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Smooth scrolling for sidebar navigation links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });
    });

// Function to download combined bar chart and table as PDF
function downloadCombinedCommodityPDF() {
    {% if forecast_summary_chart %}
    const canvas = document.getElementById('forecastSummaryBarChart');
    const ctx = canvas.getContext('2d');
    
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = canvas.width;
    tempCanvas.height = canvas.height;
    const tempCtx = tempCanvas.getContext('2d');
    
    tempCtx.fillStyle = '#ffffff';
    tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
    
    tempCtx.drawImage(canvas, 0, 0);
    
    const imgData = tempCanvas.toDataURL('image/png');
    
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({
        orientation: 'landscape',
        unit: 'mm',
        format: 'a4'
    });
    
    pdf.setFontSize(16);
    const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    const monthName = monthNames[parseInt('{{ filter_month }}')];
    pdf.text('Commodity Forecast Analysis (Top 10) - ' + monthName + ' {{ filter_year }}', 15, 15);
    
    const imgWidth = 270;
    const imgHeight = (tempCanvas.height * imgWidth) / tempCanvas.width;
    pdf.addImage(imgData, 'PNG', 15, 25, imgWidth, imgHeight);
    
    pdf.setFontSize(10);
    pdf.text('Generated on: ' + new Date().toLocaleDateString(), 15, 190);
    pdf.text('Page 1 of 2', 250, 190);
    
    pdf.addPage();
    pdf.setFontSize(16);
    pdf.text('Commodity Summary Data - ' + monthName + ' {{ filter_year }}', 15, 15);
    
    pdf.setFontSize(12);
    {% if selected_municipality == "14" %}
    pdf.text('Municipality: All of Bataan', 15, 30);
    {% else %}
    pdf.text('Municipality: {{ selected_municipality_name|default:"Selected Municipality" }}', 15, 30);
    {% endif %}
    pdf.text('Month: ' + monthName, 15, 40);
    pdf.text('Year: {{ filter_year }}', 15, 50);
    
    const tableData = [
        ['Commodity', 'Forecasted Amount (kg)']
    ];
    
    {% if forecast_summary %}
    {% for row in forecast_summary %}
    tableData.push(['{{ row.commodity }}', '{{ row.forecasted_kg|format_number }}']);
    {% endfor %}
    {% endif %}
    
    // Add table
    pdf.autoTable({
        head: [tableData[0]],
        body: tableData.slice(1),
        startY: 60,
        theme: 'grid',
        headStyles: { fillColor: [25, 135, 84] },
        styles: { fontSize: 10 },
        columnStyles: {
            0: { cellWidth: 120 },
            1: { cellWidth: 80, halign: 'right' }
        }
    });
    
    // Add page info
    pdf.setFontSize(10);
    pdf.text('Generated on: ' + new Date().toLocaleDateString(), 15, 190);
    pdf.text('Page 2 of 2', 250, 190);
    
    // Save the PDF
    pdf.save('commodity-forecast-complete-report.pdf');
    {% else %}
    alert('No chart data available to download.');
    {% endif %}
}
</script>

<!-- Add jsPDF library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

{% endblock %}