{% extends "forecasting/layout.html" %}
{% load static %}

{% block title %}
Fruit Cast | Forecast
{% endblock title %}

{% block navbar %}
    {% include "loggedin/navbar.html" %}
{% endblock navbar %}

{% block content %}
<div class="main-user py-5">

        <div class="row main-user-content justify-content-center">
            <div class="card shadow-sm rounded-4 p-4 mb-4">
                <h1 class="mb-4 text-success fw-bold">
                    Forecast{% if selected_commodity_obj %}: {{ selected_commodity_obj.name }}{% endif %}
                </h1>
                <form method="get" class="mb-4">
                    <label for="commodity_type" class="form-label">Select Commodity Type:</label>
                    <select class="form-select w-auto d-inline-block" name="commodity_id" id="commodity_type" onchange="this.form.submit()">
                        {% for commodity in commodity_types %}
                            <option value="{{ commodity.commodity_id }}" {% if commodity.commodity_id|stringformat:"s" == selected_commodity_id|stringformat:"s" %}selected{% endif %}>
                                {{ commodity.name }}
                            </option>
                        {% endfor %}
                    </select>
                </form>
                {% if forecast_data %}
                    <canvas id="forecastChart" style="height: 40vh;"></canvas>
                    <h3 class="mt-5">Monthly Forecast Data</h3>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Forecasted Amount (kg)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for month, forecast in forecast_data.combined %}
                            <tr>
                                <td>{{ month }}</td>
                                <td>{{ forecast }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <h2 class="mt-5">2D Mapping</h2>
                    <div id="map" style="height: 500px; z-index: 0"></div>
                {% else %}
                    <div class="alert alert-warning">Not enough data to generate a forecast for this commodity.</div>
                {% endif %}
            </div>
        </div>
</div>

<!-- Chart.js and Leaflet -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
{% if forecast_data %}
    var forecastChart = new Chart(document.getElementById('forecastChart'), {
      type: 'line',
      data: {
        labels: {{ forecast_data.labels|safe }},
        datasets: [{
          label: 'Forecasted Amount (kg)',
          data: {{ forecast_data.forecasted_count|safe }},
          borderColor: 'rgba(75, 192, 192, 1)',
          fill: false
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: { title: { display: true, text: 'Month' } },
          y: { title: { display: true, text: 'Amount (kg)' } }
        }
      }
    });
{% endif %}

// Initialize Leaflet map
var map = L.map('map').setView([14.678, 120.536], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

var mapData = {{ map_data|safe }};
mapData.forEach(function(item) {
    if (item.latitude && item.longitude) {
        var marker = L.marker([item.latitude, item.longitude]).addTo(map);
        marker.bindPopup('<b>' + item.barangay + ', ' + item.municipality + '</b><br>Forecasted Amount: ' + item.forecasted_amount.toFixed(2) + ' kg');
    }
});
</script>
{% endblock content %}
